{% extends "omeroweb/base.html" %}
{% load i18n %}
{% load markup %}
{% load custom_tags %}
{% load wikitags %}

{% block link %}
    <link rel="stylesheet" href="{% get_webclient_static_url %}/css/thickbox.css" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% get_webclient_static_url %}/css/annotation.css" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% get_webclient_static_url %}/css/table.css" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% get_webclient_static_url %}/css/autocomplete.css" type="text/css" media="screen"/>
{% endblock %}

{% block jscript %}
    <script type="text/javascript" src="{% get_webclient_static_url %}/javascript/jquery_1.2.6.js"></script>
    
    <script type="text/javascript" src="{% get_webclient_static_url %}/javascript/jquery.bgiframe.js"></script>
    <script type="text/javascript" src="{% get_webclient_static_url %}/javascript/jquery.ajaxQueue.js"></script>
    <script type="text/javascript" src="{% get_webclient_static_url %}/javascript/jquery.autocomplete.js"></script>
    
    <script type="text/javascript" src="{% get_webclient_static_url %}/javascript/jquery.tablesorter.js"></script>
    <script type="text/javascript" src="{% get_webclient_static_url %}/javascript/jquery.quicksearch.js"></script>
    
    <script type="text/javascript" src="{% get_webclient_static_url %}/javascript/ui/ui.core.js"></script>
    
    <script type="text/javascript" src="{% get_webclient_static_url %}/javascript/thickbox/thickbox.js"></script>
{% endblock %}


{% block script %}
    <script type="text/javascript" src="{% get_webclient_static_url %}/javascript/menu.js"></script>
    <script type="text/javascript" src="{% get_webclient_static_url %}/javascript/basket.js"></script>
    <script type="text/javascript" src="{% get_webclient_static_url %}/javascript/blitzcon.js"></script>
    
    <script type="text/javascript">
        $(document).ready(function() 
            { 
                $("#dataTable").tablesorter( {sortList: [[1,1]]} ); 
            
                $('table#dataTable tbody tr').quicksearch({
                    attached: "table#dataTable",
                    position: "before",
                    stripeRowClass: null,
                    labelText: '{% trans "Filter" %}:',
                    inputText: '...',
                    loaderImg: '{% get_webclient_static_url %}/images/tree/spinner.gif',
                });
                
                $("div#tag").hide();
                $("div#tagloader").html('<p>{% trans "Loading filters... please wait" %} <img src="{% get_webclient_static_url %}/images/tree/spinner.gif"/></p>');
                
                $.ajax({  
                    type: "GET",  
                    url: "{% get_webclient_root_url %}/autocompletetags/",  
                    contentType: "application/json; charset=utf-8",  
                    cache:false,
    				async: false,
    				dataType: "json",  
                    success: function(json){  
                        prepareAutocomplite(json);
                        $("div#tagloader").remove();
                        $("div#tag").show();
                    },  
                    error: function(xhr, msg){  
                        alert("{% trans 'Could not load tag component. Please contact Administrator.' %}");  
                    }
                });
                
                function prepareAutocomplite(myjson){
                    $("#id_tag, #id_tag2, #id_tag3, #id_tag4, #id_tag5").autocomplete(myjson, {
                        //width: 320,
                        max: 10,
                        scroll: true,
                        scrollHeight: 200,
                        highlightItem: true,
                        //multiple: true,
                        //multipleSeparator: ";",
                        formatItem: function(row, i, max, term) {
                            if(row.desc!=null) {
                                return row.tag + "<br/><small>" + row.desc + "</small>";
                            } else {
                                return row.tag
                            }
                        },
                        formatMatch: function(row, i, max) {
                            return row.tag + " " + row.id;
                        },
                        formatResult: function(row) {
                            return row.tag;
                        }
                    });
                }

        });
    </script>
    
{% endblock %}

{% block center %}

<div class="tag">
    <h1>{% trans "Tags" %}:</h1>
    <p>{% trans "That page allows you to display the data by tags. Please start typing tag and choose correct tag from auto-complete list. You can choose from 1 to 5 tags. Filter will show you ever data associated with those tags." %}</p>
</div>

<div>
    {% if manager.tags %}
    <h1>{% trans "Selected tags" %}:</h1>
    {% endif %}
    <div id="tagloader"></div>
    <div id="tag">
        {% if form_filter %}
        <form action="" method="post">
        <table>
            <tr>
                {% for t in manager.tags %}
                <td>{% if t %}
                    ({{ t.id }}) {{ t.textValue }} {% if not t.isOwned %}<img src="{% get_webclient_static_url %}/images/kgpg16.png" alt="l" title="locked"/>{% endif %} {% if t.isEditable %}<a href="{% get_webclient_root_url %}/action/edit/tag/{{ t.id }}/?url={{url}}"><img src="{% get_webclient_static_url %}/images/color_line16.png" alt="e" title="edit"/></a>{% endif %}
                {% else %}
                    <ul class="errorlist"><li>{% trans "This tag does not exist." %}</li></ul>
                {% endif %}</td><td> </td>
                {% endfor %}
                <td> </td>
            <tr>
                <td>{{ form_filter.tag }}</td><td>{% if form_filter.tag.errors %}{{ form_filter.tag.errors }}{% endif %}<br/>{{ form_filter.tag.help_text|safe }}</td>
                <td>{{ form_filter.tag2 }}</td><td>{% if form_filter.tag2.errors %}{{ form_filter.tag2.errors }}{% endif %}<br/>{{ form_filter.tag2.help_text|safe }}</td>
                <td>{{ form_filter.tag3 }}</td><td>{% if form_filter.tag3.errors %}{{ form_filter.tag3.errors }}{% endif %}<br/>{{ form_filter.tag3.help_text|safe }}</td>
                <td>{{ form_filter.tag4 }}</td><td>{% if form_filter.tag4.errors %}{{ form_filter.tag4.errors }}{% endif %}<br/>{{ form_filter.tag4.help_text|safe }}</td>
                <td>{{ form_filter.tag5 }}</td><td>{% if form_filter.tag5.errors %}{{ form_filter.tag5.errors }}{% endif %}<br/>{{ form_filter.tag5.help_text|safe }}</td>
                <td><input type="submit" value="Filter" /></td>
            </tr>
        </table>
        </form>
        {% endif %}
    </div>
</div>

<div class="separate70"></div>

<div id="view"> 

    {% if manager.c_size %}
        <h1>{% trans "Data" %}({{ manager.c_size }} {% trans "items" %}):</h1>
    {% else %}
        <h1>{% trans "Data (no item)" %}:</h1>
    {% endif %}
    <!--| View <a href="{% get_webclient_root_url %}/mydata/{% if manager.project %}project/{{manager.project.id}}/{% endif %}{% if manager.dataset.id %}dataset/{{manager.dataset.id}}/{% endif %}?view=table"><img src="{% get_webclient_static_url %}/images/view_detailed16.png" alt="details" title="details"/></a> <a href="{% get_webclient_root_url %}/mydata/{% if manager.project %}project/{{manager.project.id}}/{% endif %}{% if manager.dataset.id %}dataset/{{manager.dataset.id}}/{% endif %}?view=icon"><img src="{% get_webclient_static_url %}/images/view_icon16.png" alt="icon" title="icon"/></a> <a href="{% get_webclient_root_url %}/mydata/?view=tree"><img src="{% get_webclient_static_url %}/images/view_tree16.png" alt="tree" title="tree"/></a> |-->

</div>

<div class="clear"> </div>

{% if not manager.c_size %}
    <h1>{% trans "No data." %}</h1>
{% else %}
    
    {% if manager.c_size %}
    <div>
    <table id="dataTable" class="tablesorter"> 
    <thead> 
    <tr> 
        <th>{% trans "Type" %}</th> 
        <th>{% trans "Name" %}</th> 
        <th>{% trans "Action" %}</th> 
        {% for t in manager.tags %}
            {% if t %}<th>{{ t.id }}</th>{% endif %}
        {% endfor %}
    </tr> 
    </thead> 
    <tbody> 
        {% for c in manager.containers.projects %}
        <tr> 
            <td class="product">{% if c.isOwned %}<a href="{% get_webclient_root_url %}/mydata/project/{{ c.id }}/"><img id="{{ c.id }}" src="{% get_webclient_static_url %}/images/folder32.png" title="{{ c.name }}" alt="project"/></a>{% else %}<a href="{% get_webclient_root_url %}/userdata/project/{{ c.id }}/?filter=experimenter&experimenter={{ c.details.owner.id.val }}"><img id="{{ c.id }}" src="{% get_webclient_static_url %}/images/folder32.png" title="{{ c.name }}" alt="project"/></a>{% endif %}</td> 
            <td>{% if c.isOwned %}<a href="{% get_webclient_root_url %}/mydata/project/{{ c.id }}/">{{ c.shortName }}</a>{% else %}<a href="{% get_webclient_root_url %}/userdata/project/{{ c.id }}/?filter=experimenter&experimenter={{ c.details.owner.id.val }}">{{ c.shortName }}</a>{% endif %} <img alt="dataset" title="dataset" src="{% get_webclient_static_url %}/images/folder_image16.png"/>[{{ c.countChild }}]{% if not c.isOwned %} <img src="{% get_webclient_static_url %}/images/kgpg16.png" alt="l" title="locked"/>{% endif %}{% if c.countAnnotations %} <img src="{% get_webclient_static_url %}/images/knotes16.png" alt="a" title="annotation"/>[{{ c.countAnnotations }}]{% endif %}</td> 
            <td></td>
            {% for t in manager.tags %}
                {% if t %}<td>{% for ch in c.copyAnnotationLinks %} {%ifequal ch.child.id.val t.id %}{% if c.isEditable %}<a href="{% get_webclient_root_url %}/action/remove/?parent=pr-{{ c.id }}&source=tann-{{ t.id }}&url={{ url }}" onClick="return confirm('Unlink tag?');"><img src="{% get_webclient_static_url %}/images/cut16.png" alt="u" title="unlink"/></a>{% else %}<img src="{% get_webclient_static_url %}/images/apply16.png" alt="x" title="x"/>{% endif %}{% endifequal %} {% endfor %}</td>{% endif %}
            {% endfor %}
        </tr> 
        {% endfor %}
        {% for c in manager.containers.datasets %}
        <tr> 
            <td class="product">{% if c.isOwned %}<a href="{% get_webclient_root_url %}/mydata/{% if manager.project %}project/{{manager.project.id}}/{% endif %}dataset/{{ c.id }}/"><img id="{{ c.id }}" src="{% get_webclient_static_url %}/images/folder_image32.png" title="{{ c.name }}" alt="project"/></a>{% else %}<a href="{% get_webclient_root_url %}/userdata/{% if manager.project %}project/{{manager.project.id}}/{% endif %}dataset/{{ c.id }}/?filter=experimenter&experimenter={{ c.details.owner.id.val }}"><img id="{{ c.id }}" src="{% get_webclient_static_url %}/images/folder_image32.png" title="{{ c.name }}" alt="project"/></a>{% endif %}</td> 
            <td>{% if c.isOwned %}<a href="{% get_webclient_root_url %}/mydata/{% if manager.project %}project/{{manager.project.id}}/{% endif %}dataset/{{ c.id }}/">{{ c.shortName }}</a>{% else %}<a href="{% get_webclient_root_url %}/userdata/{% if manager.project %}project/{{manager.project.id}}/{% endif %}dataset/{{ c.id }}/?filter=experimenter&experimenter={{ c.details.owner.id.val }}">{{ c.shortName }}</a>{% endif %} <img src="{% get_webclient_static_url %}/images/image16.png" title="image" alt="image"/>[{{ c.countChild }}]{% if not c.isOwned %} <img src="{% get_webclient_static_url %}/images/kgpg16.png" alt="l" title="locked"/>{% endif %}{% if c.countAnnotations %} <img src="{% get_webclient_static_url %}/images/knotes16.png" alt="a" title="annotation"/>[{{ c.countAnnotations }}]{% endif %}</td> 
            <td><!--{% if c.isOwned %}<a href="#" onclick="toBasket('dataset', '{{ c.id }}'); return false;"><img src="{% get_webclient_static_url %}/images/basket16.png" alt="b" title="basket"/></a>{% endif %} --><a href="#" onclick="copyToClipboard('dataset', '{{ c.id }}'); return false;"><img src="{% get_webclient_static_url %}/images/eclipse_copy_edit16.png" alt="c" title="copy"/></a></td>
            {% for t in manager.tags %}
                {% if t %}<td>{% for ch in c.copyAnnotationLinks %} {%ifequal ch.child.id.val t.id %}{% if c.isEditable %}<a href="{% get_webclient_root_url %}/action/remove/?parent=ds-{{ c.id }}&source=tann-{{ t.id }}&url={{ url }}" onClick="return confirm('Unlink tag?');"><img src="{% get_webclient_static_url %}/images/cut16.png" alt="u" title="unlink"/></a>{% else %}<img src="{% get_webclient_static_url %}/images/apply16.png" alt="x" title="x"/>{% endif %}{% endifequal %} {% endfor %}</td>{% endif %}
            {% endfor %}
        </tr> 
        {% endfor %}
        {% for c in manager.containers.images %}
        <tr> 
            <td class="product">{% if c.isOwned %}<a href="{% get_webclient_root_url %}/mydata/image/{{ c.id }}/"><img id="{{ c.id }}" src="{% get_webclient_static_url %}/images/image32.png" title="{{ c.name }}" alt="image"/></a>{% else %}<a href="{% get_webclient_root_url %}/userdata/image/{{ c.id }}/"><img id="{{ c.id }}" src="{% get_webclient_static_url %}/images/image32.png" title="{{ c.name }}" alt="image"/></a>{% endif %}</td> 
            <td>{% if c.isOwned %}<a href="{% get_webclient_root_url %}/mydata/{% if manager.project %}project/{{manager.project.id}}/{% endif %}{% if manager.dataset %}dataset/{{manager.dataset.id}}/{% endif %}image/{{ c.id }}/">{{ c.shortName }}</a> {% else %}<a href="{% get_webclient_root_url %}/userdata/{% if manager.project %}project/{{manager.project.id}}/{% endif %}{% if manager.dataset %}dataset/{{manager.dataset.id}}/{% endif %}image/{{ c.id }}/">{{ c.shortName }}</a>{% endif %}{% if not c.isOwned %} <img src="{% get_webclient_static_url %}/images/kgpg16.png" alt="l" title="locked"/>{% endif %}{% if c.countAnnotations %} <img src="{% get_webclient_static_url %}/images/knotes16.png" alt="a" title="annotation"/>[{{ c.countAnnotations }}]{% endif %}</td> 
            <td><a href="#" onclick="popup('','_blank','{{ c.id }}'); return false;"><img src="{% get_webclient_static_url %}/images/kview16.png" title="{{ c.name }}" alt="image"/></a> <a href="{% get_webclient_root_url %}/image_zoom/{{ c.id }}/?keepThis=true&TB_iframe=true&height=500&width=860" alt="{{ c.shortName }}" class="thickbox" rel="gallery-omero" title="{{ c.shortName }} by {{ c.getOwner }} ({{ c.details.group.name.val }} {{ c.details.permissions }})"><img src="{% get_webclient_static_url %}/images/kpresenter16.png" alt="p" title="presentation"/></a>{% if c.isOwned %} <a href="#" onclick="toBasket('image', '{{ c.id }}'); return false;"><img src="{% get_webclient_static_url %}/images/basket16.png" alt="b" title="basket"/></a>{% endif %} <a href="#" onclick="copyToClipboard('image', '{{ c.id }}'); return false;"><img src="{% get_webclient_static_url %}/images/eclipse_copy_edit16.png" alt="c" title="copy"/></a></td>
            {% for t in manager.tags %}
                {% if t %}<td>{% for ch in c.copyAnnotationLinks %} {%ifequal ch.child.id.val t.id %}{% if c.isEditable %}<a href="{% get_webclient_root_url %}/action/remove/?parent=img-{{ c.id }}&source=tann-{{ t.id }}&url={{ url }}" onClick="return confirm('Unlink tag?');"><img src="{% get_webclient_static_url %}/images/cut16.png" alt="u" title="unlink"/></a>{% else %}<img src="{% get_webclient_static_url %}/images/apply16.png" alt="x" title="x"/>{% endif %}{% endifequal %} {% endfor %}</td>{% endif %}
            {% endfor %}
        </tr> 
        {% endfor %}
    </tbody> 
    </table>
    </div>
    {% endif %}
    
{% endif %}

<div class="separate70"></div>

{% endblock %}

{% block advice %}
    {% include "omeroweb/advice.html" %}
{% endblock %}