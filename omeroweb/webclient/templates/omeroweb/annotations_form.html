{% extends "omeroweb/base_frame.html" %}
{% load i18n %}
{% load markup %}
{% load custom_tags %}

{% block link %}
    <link rel="stylesheet" href="{% url webstatic "css/images.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/googiespell.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/annotation.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/autocomplete.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/tooltip.css" %}" type="text/css" media="screen"/>

    <link rel="stylesheet" href="/webgateway/appmedia/css/jquery-plugin-slider.css" type="text/css" media="screen"/>
    <link rel="stylesheet" href="/webgateway/appmedia/css/weblitz-viewport.css" type="text/css" media="screen"/>
{% endblock %}

{% block jscript %}

    <script type="text/javascript" src="{% url webstatic "javascript/jquery.autocomplete.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/jquery.tooltip.js" %}"></script>
  
    <script type="text/javascript" src="{% url webstatic "javascript/ui/ui.core.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/ui/ui.tabs.js" %}"></script>
    
    <script type="text/javascript" src="{% url webstatic "javascript/googiespell/AJS.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/googiespell/googiespell.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/googiespell/cookiesupport.js" %}"></script>
    
    {% if manager.image or manager.well %}
    <script type="text/javascript" src="/webgateway/appmedia/js/weblitz-viewport.js"></script>
    <script type="text/javascript" src="/webgateway/appmedia/js/jquery-plugin-viewportImage.js"></script>
    <script type="text/javascript" src="/webgateway/appmedia/js/jquery-plugin-slider.js"></script>
    <script type="text/javascript" src="/webgateway/appmedia/js/gs_utils.js"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/image.js" %}"></script>
    
    {% endif %}
    
    <script type="text/javascript">
        $(document).ready(function() 
            {
                $("#annotation_tabs").tabs();               
                {% if manager.image %}
                    var viewport = $.WeblitzViewport($("#viewport"), "/webgateway" );
                    viewport.load({{ manager.image.id }});
                {% endif %}
                {% if manager.well %}
                    var viewport = $.WeblitzViewport($("#viewport"), "/webgateway" );
                    viewport.load({{ manager.well.selectedWellSample.image.id }});
                {% endif %}

                $("{% for t in manager.tag_annotations %}#tagdesc{{ t.id }}, {% endfor %}#tag").tooltip({ 
                    track: true, 
                    delay: 0, 
                    showURL: false, 
                    opacity: 1, 
                    fixPNG: true, 
                    showBody: " - ", 
                    top: -15, 
                    left: 5 
                });

            });

    </script>
    
{% endblock %}

{% block content %}
<div id="annotation_form" >
    <div id="annotation_tabs" class="ui-tabs">
        <ul>
            {% if manager.image or manager.well %}<li>|&nbsp;<a href="#preview_tab">{% trans "Preview" %}</a>&nbsp;</li>{% endif %}
            <li>|&nbsp;<a href="#metadata_tab">{% trans "Metadata" %}</a>&nbsp;</li>
            <li>|&nbsp;<a href="#comment_tab">{% trans "Comments" %}</a>&nbsp;</li>
            <li>|&nbsp;<a href="#tags_tab">{% trans "Tags" %}</a>&nbsp;</li>
            <li>|&nbsp;<a href="#file_tab">{% trans "Attachments" %}</a>&nbsp;|</li>
        </ul>
        <div class="clear"></div>        
        
        {% if manager.image %}
        <!-- VIEWER -->
        <div id="preview_tab">
            <h1>{{ manager.image.name }}</h1>
            <p>{% trans "Launch full viewer" %} <a href="#" onclick="return popup('{% url image_viewer manager.image.id %}')"><img id="{{ manager.image.id }}" src="{% url webstatic "images/kview16.png" %}" alt="image" title="image"/></a></p>
            <div class="miniview" id="viewport"></div>
        </div>
        {% endif %}
        {% if manager.well %}
        <!-- VIEWER -->
        <div id="preview_tab">
            <h1>{{ manager.well.selectedWellSample.image.name }}</h1>
            <p>{% trans "Launch full viewer" %} <a href="#" onclick="return popup('{% url image_viewer manager.well.selectedWellSample.image.id %}')"><img id="{{ manager.image.id }}" src="{% url webstatic "images/kview16.png" %}" alt="image" title="image"/></a></p>
            <div class="miniview" id="viewport"></div>
        </div>
        {% endif %}
        
        <!-- METADATA -->
        <div id="metadata_tab">
            {% if manager.image %}
            <table>
                <tr><th rowspan="2"><a href="#" onclick="return popup('{% url image_viewer manager.image.id %}')"><img id="{{ manager.image.id }}" src="{% url render_thumbnail_resize 64 manager.image.id %}" alt="image" title="image" class="thumbnail"/></a><br/>
                    </th><td><label>{{ manager.image.name }}</label>{% if manager.image.isEditable %} <a href="{% url manage_action_containers "edit" "image" manager.image.id %}?url={{url}}"><img src="{% url webstatic "images/color_line16.png" %}" alt="e" title="edit"/></a>{% endif %}</td></tr>
                <tr><td>Created on: {{ manager.image.getDate|date:"Y-m-d H:i:s" }}</td></tr>
                <tr><td colspan="2">
                    {% if manager.image.isPublic %}<img src="{% url webstatic "images/network16.png" %}" alt="p" title="{{ manager.image.details.permissions }}"/>Public{% else %}{% if manager.image.isShared %}<img src="{% url webstatic "images/kuser16.png" %}" alt="s" title="{{ manager.image.details.permissions }}"/>Shared{% else %}{% if manager.image.isPrivate %}Private{% endif %}{% endif %}{% endif %}
                    {% if manager.image.isReadOnly %} (read-only){% endif %}</td></tr>
                <tr><td colspan="2"><label>{{ manager.image.description|default_if_none:""|linebreaks }}</label></td></tr>
            </table>
            {% else %}
                {% if manager.dataset %}
                <table>
                    <tr><th rowspan="3"><img src="{% url webstatic "images/folder_image64.png" %}" alt="dataset" title="dataset"/><br/>
                        </th><td><label>{{ manager.dataset.name }}</label>{% if manager.dataset.isEditable %} <a href="{% url manage_action_containers "edit" "dataset" manager.dataset.id %}?url={{url}}"><img src="{% url webstatic "images/color_line16.png" %}" alt="e" title="edit"/></a>{% endif %}</td></tr>
                    <tr><td>Includes {{ manager.dataset.countChildren }} image(s)</td></tr>
                    <tr><td>Created on: {{ manager.dataset.getDate|date:"Y-m-d H:i:s" }}</td></tr>
                    <tr><td colspan="2">
                        {% if manager.dataset.isPublic %}<img src="{% url webstatic "images/network16.png" %}" alt="p" title="{{ manager.dataset.details.permissions }}"/>Public{% else %}{% if manager.dataset.isShared %}<img src="{% url webstatic "images/kuser16.png" %}" alt="s" title="{{ manager.dataset.details.permissions }}"/>Shared{% else %}{% if manager.dataset.isPrivate %}Private{% endif %}{% endif %}{% endif %}
                        {% if manager.dataset.isReadOnly %} (read-only){% endif %}</td></tr>
                    <tr><td colspan="2"><label>{{ manager.dataset.description|default_if_none:""|linebreaks }}</label></td></tr>
                </table>
                {% else %}
                    {% if manager.project %}
                    <table>
                        <tr><th rowspan="3"><img src="{% url webstatic "images/folder64.png" %}" alt="project" title="project"/><br/>
                            </th><td><label>{{ manager.project.name }}</label>{% if manager.project.isEditable %} <a href="{% url manage_action_containers "edit" "project" manager.project.id %}?url={{url}}"><img src="{% url webstatic "images/color_line16.png" %}" alt="e" title="edit"/></a>{% endif %}</td></tr>
                        <tr><td>Includes {{ manager.project.countChildren }} image(s)</td></tr>
                        <tr><td>Created on: {{ manager.project.getDate|date:"Y-m-d H:i:s" }}</td></tr>
                        <tr><td colspan="2">
                            {% if manager.project.isPublic %}<img src="{% url webstatic "images/network16.png" %}" alt="p" title="{{ manager.project.details.permissions }}"/>Public{% else %}{% if manager.project.isShared %}<img src="{% url webstatic "images/kuser16.png" %}" alt="s" title="{{ manager.project.details.permissions }}"/>Shared{% else %}{% if manager.project.isPrivate %}Private{% endif %}{% endif %}{% endif %}
                            {% if manager.project.isReadOnly %} (read-only){% endif %}</td></tr>
                        <tr><td colspan="2"><label>{{ manager.project.description|default_if_none:""|linebreaks }}</label></td></tr>
                    </table>
                    {% endif %}
                {% endif %}
            {% endif %}
            
            {% if manager.well %}
            <table>
                <tr><th rowspan="2"><a href="#" onclick="return popup('{% url image_viewer manager.well.selectedWellSample.image.id %}')"><img id="{{ manager.well.selectedWellSample.image.id }}" src="{% url render_thumbnail_resize 64 manager.well.selectedWellSample.image.id %}" alt="image" title="image" class="thumbnail"/></a><br/>
                    </th><td><label>{{ manager.well.selectedWellSample.image.name }}</label>{% if manager.well.selectedWellSample.image.isEditable %} <a href="{% url manage_action_containers "edit" "image" manager.well.selectedWellSample.image.id %}?url={{url}}"><img src="{% url webstatic "images/color_line16.png" %}" alt="e" title="edit"/></a>{% endif %}</td></tr>
                <tr><td>Created on:{{ manager.well.selectedWellSample.image.getDate|date:"Y-m-d H:i:s" }}</td></tr>
                <tr><td colspan="2">
                    {% if manager.well.selectedWellSample.image.isPublic %}<img src="{% url webstatic "images/network16.png" %}" alt="p" title="{{ manager.image.details.permissions }}"/>Public{% else %}{% if manager.well.selectedWellSample.image.isShared %}<img src="{% url webstatic "images/kuser16.png" %}" alt="s" title="{{ manager.image.details.permissions }}"/>Shared{% else %}{% if manager.well.selectedWellSample.image.isPrivate %}Private{% endif %}{% endif %}{% endif %}
                    {% if manager.well.selectedWellSample.image.isReadOnly %} (read-only){% endif %}</td></tr>
                <tr><td colspan="2"><label>{{ manager.well.selectedWellSample.image.description|default_if_none:""|linebreaks }}</label></td></tr>
            </table>
            {% else %}
                {% if manager.plate %}
                <table>
                    <tr><th rowspan="3"><img src="{% url webstatic "images/folder_plate64.png" %}" alt="plate" title="plate"/><br/>
                        </th><td><label>{{ manager.plate.name }}</label>{% if manager.plate.isEditable %} <a href="{% url manage_action_containers "edit" "plate" manager.plate.id %}?url={{url}}"><img src="{% url webstatic "images/color_line16.png" %}" alt="e" title="edit"/></a>{% endif %}</td></tr>
                    <tr><td>Created on: {{ manager.plate.getDate|date:"Y-m-d H:i:s" }}</td></tr>
                    <tr><td colspan="2">
                        {% if manager.plate.isPublic %}<img src="{% url webstatic "images/network16.png" %}" alt="p" title="{{ manager.plate.details.permissions }}"/>Public{% else %}{% if manager.plate.isShared %}<img src="{% url webstatic "images/kuser16.png" %}" alt="s" title="{{ manager.plate.details.permissions }}"/>Shared{% else %}{% if manager.plate.isPrivate %}Private{% endif %}{% endif %}{% endif %}
                        {% if manager.dataset.isReadOnly %} (read-only){% endif %}</td></tr>
                    <tr><td colspan="2"><label>{{ manager.plate.description|default_if_none:""|linebreaks }}</label></td></tr>
                </table>
                {% else %}
                    {% if manager.screen %}
                    <table>
                        <tr><th rowspan="3"><img src="{% url webstatic "images/folder_screen64.png" %}" alt="plate" title="plate"/><br/>
                            </th><td><label>{{ manager.screen.name }}</label>{% if manager.screen.isEditable %} <a href="{% url manage_action_containers "edit" "screen" manager.screen.id %}?url={{url}}"><img src="{% url webstatic "images/color_line16.png" %}" alt="e" title="edit"/></a>{% endif %}</td></tr>
                        <tr><td>Includes {{ manager.screen.countChildren }} plate(s)</td></tr>
                        <tr><td>Created on: {{ manager.screen.getDate|date:"Y-m-d H:i:s" }}</td></tr>
                        <tr><td colspan="2">
                            {% if manager.screen.isPublic %}<img src="{% url webstatic "images/network16.png" %}" alt="p" title="{{ manager.screen.details.permissions }}"/>Public{% else %}{% if manager.screen.isShared %}<img src="{% url webstatic "images/kuser16.png" %}" alt="s" title="{{ manager.screen.details.permissions }}"/>Shared{% else %}{% if manager.screen.isPrivate %}Private{% endif %}{% endif %}{% endif %}
                            {% if manager.screen.isReadOnly %} (read-only){% endif %}</td></tr>
                        <tr><td colspan="2"><label>{{ manager.screen.description|default_if_none:""|linebreaks }}</label></td></tr>
                    </table>
                    {% endif %}
                {% endif %}
            {% endif %}
            
            {% if manager.well or manager.image%}
            <h1>Acquisition metadata:</h1>
            
            <table class="metadata_details">
                {% if manager.image %}
                <tr><td><label>{% trans "Dimensions" %} (XYZT): </label></td><td>{{ manager.image.getWidth }} x {{ manager.image.getHeight }} x {{ manager.image.z_count }} x {{ manager.image.t_count }}</td></tr>
                <tr><td><label>{% trans "Pixel size" %} (XYZ) [&micro;m]: </label></td><td>{{ manager.image.getPixelSizeX|default_if_none:"-" }} x {{ manager.image.getPixelSizeY|default_if_none:"-" }} x {{ manager.image.getPixelSizeZ|default_if_none:"-" }}</td></tr>
                <tr><th colspan="3"><br/></th></tr>
                {% endif %}
                {% if manager.well %}
                <tr><td><label>{% trans "Dimensions" %} (XYZT): </label></td><td>{{ manager.well.selectedWellSample.image.getWidth }} x {{ manager.well.selectedWellSample.image.getHeight }} x {{ manager.well.selectedWellSample.image.z_count }} x {{ manager.well.selectedWellSample.image.t_count }}</td></tr>
                <tr><td><label>{% trans "Pixel size" %} (XYZ) [&micro;m]: </label></td><td>{{ manager.well.selectedWellSample.image.getPixelSizeX|default_if_none:"-" }} x {{ manager.well.selectedWellSample.image.getPixelSizeY|default_if_none:"-" }} x {{ manager.well.selectedWellSample.image.getPixelSizeZ|default_if_none:"-" }}</td></tr>
                <tr><th colspan="3"><br/></th></tr>
                {% endif %}
            </table>

            <table class="metadata_details">
            {% if manager.global_metadata %}
                <tr><th colspan="3" class="header"><h1>{% trans "Global metadata" %}: <input type="button" value="Download" onClick="document.location.href='{% url manage_annotation "download" manager.original_metadata.id %}';"/></h1></th></tr>
                {% for gm in manager.global_metadata %}
                    <tr><td><label>{{ gm.0 }}</label></td><td>{{ gm.1 }}</td></tr>
                {% endfor %}
                <tr><th colspan="3"><br/></th></tr>
            {% endif %}
            {% if manager.series_metadata %}
                <tr><th colspan="3" class="header"><h1>{% trans "Series metadata" %}: <input type="button" value="Download" onClick="document.location.href='{% url manage_annotation "download" manager.original_metadata.id %}';"/></h1></th></tr>
                {% for sm in manager.series_metadata %}
                    <tr><td><label>{{ sm.0 }}</label></td><td>{{ sm.1 }}</td></tr>
                {% endfor %}
                <tr><th colspan="3"><br/></th></tr>
            {% endif %}
            {% if form_objective or form_environment or form_stageLabel %}
                <tr><th colspan="3" class="header"><h1>{% trans "Image" %}:</h1></th></tr>
                {% if form_objective %}
                <tr><th><br/>{% trans "Objective" %}:</th><th colspan="2"></th></tr>
                    {% for field in form_objective %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
                {% if form_environment %}
                <tr><th><br/>{% trans "Environment" %}:</th><th colspan="2"></th></tr>
                    {% for field in form_environment %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
                {% if form_stageLabel %}
                <tr><th><br/>{% trans "Stage label" %}:</th><th colspan="2"></th></tr>
                    {% for field in form_stageLabel %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
                <tr><th colspan="3"><br/></th></tr>
            {% endif %}
            {% if form_objective or form_filters or form_detectors %}
                <tr><th colspan="3" class="header"><h1>{% trans "Microscope" %}:</h1></th></tr>
                {% if form_objective %}
                <tr><th><br/>{% trans "Objective" %}:</th><th colspan="2"></th></tr>
                    {% for field in form_objective %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
                {% for form in form_filters %}
                    <tr><th><br/>{% trans "Filter" %}:</th><th colspan="2"></th></tr>
                    {% for field in form %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text }}</td>
                    </tr>
                    {% endfor %}
                {% endfor %}
                {% for form in form_detectors %}
                    <tr><th><br/>{% trans "Detector" %}:</th><th colspan="2"></th></tr>
                    {% for field in form %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text }}</td>
                    </tr>
                    {% endfor %}
                {% endfor %}
                <tr><th colspan="3"><br/></th></tr>
            {% endif %}
            {% for ch in form_channels %}
                <tr><th colspan="3" class="header"><h1>{% trans "Channel" %} : <span style="padding:0 3px; color:#000; border:1px solid #bbb; ;background-color: #{{ ch.color }};">{{ ch.name }}</span></h1></th></tr>
                {% for field in ch.form %}
                <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                    <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text }}</td>
                </tr>
                {% endfor %}
                {% if ch.form_emission_filter %}
                <tr><th><br/>{% trans "Filter" %}:</th><th colspan="2"></th></tr>
                {% for field in ch.form_emission_filter %}
                <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                    <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text }}</td>
                </tr>
                {% endfor %}
                {% endif %}
                {% if ch.form_detector_settings %}
                <tr><th><br/>{% trans "Detector" %}:</th><th colspan="2"></th></tr>
                {% for field in ch.form_detector_settings %}
                <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                    <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text }}</td>
                </tr>
                {% endfor %}
                {% endif %}
                {% if ch.form_light_source %}
                <tr><th><br/>{% trans "Light source" %}:</th><th colspan="2"></th></tr>
                {% for field in ch.form_light_source %}
                <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                    <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text }}</td>
                </tr>
                {% endfor %}
                {% endif %}
                {% if ch.form_dichroic %}
                <tr><th><br/>{% trans "Dichroic" %}:</th><th colspan="2"></th></tr>
                {% for field in ch.form_dichroic %}
                <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                    <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text }}</td>
                </tr>
                {% endfor %}
                {% endif %}
                <tr><th colspan="3"><br/></th></tr>
            {% endfor %}
            </table>
            <br/><p>*{% trans "N/A - this value is not available." %}</p>
            {% endif %}
            <div class="clear"></div>
        </div>        
        
        <!-- ANNOTATIONS -->
        <div id="comment_tab">
            <h1>{% trans "Comments" %}:</h1>
            {% if manager.txannSize %}
            <div class="lncomments">            
                {% for tann in manager.text_annotations %}
                <div id="ann_comment_wrapper">
                    <div class="avatar"><img src="{% url load_photo tann.details.owner.id.val %}" alt="{{ tann.getOwnerFullName }}" title="{{ tann.getOwnerFullName }}" width="40" height="40" /></div>
                    <div class="ann_comment"><span class="ann_comment_header">{{ tann.getOwnerFullName }} {% trans "posted comment at" %} {{ tann.creationEventDate|date:"Y-m-d H:i:s" }}</span> {% if tann.canWrite %}<a href="{% url manage_action_containers "edit" "comment" tann.id %}?url={{ url }}"><img src="{% url webstatic "images/color_line16.png" %}" alt="e" title="edit"/></a>{% endif %}<br/>
                        {{ tann.textValue|safe|linebreaks }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
                <p>Have not been commented yet.</p>    
            {% endif %}
            
            <div class="clear"></div>
            
            {% if form_comment %}
            <div class="comment">
                <h1>{% trans "Add new comment" %}:</h1>
                <form action="#comment_tab" method="post"><input type="hidden" name="action" value="comment" />
                <table>
                    {% for field in form_comment %}
                        <tr>
                            <td colspan="2">{% if field.errors %}{{ field.errors }}{% endif %}</td>
                        </tr>
                        <tr>
                            <td>{{ field }}</td><td>{{ field.help_text|safe }}</td>
                        </tr>
                    {% endfor %}
                        <tr><td colspan="2"><input type="submit" value="{% trans 'Save' %}" /></td></tr>
                </table>
                </form>
                <script type="text/javascript">
                    var googie_spell = new GoogieSpell("static_core/googiespell/", "{% url spellchecker %}"+"?lang=");
                    googie_spell.decorateTextarea("id_content", null, "600px");
                </script>
            </div>
            {% endif %}

            <div class="clear"></div>
        </div>
        
        <!-- TAGS -->
        <div id="tags_tab">
            <h1>{% trans "Tags" %}:</h1>
            {% if manager.tgannSize %}
            <div class="lntags"> <h1>                  
            {% for tag in manager.tag_annotations %}
                <span id="tagdesc{{ tag.id }}" title="{{ tag.textValue }} - <small>{{ tag.description|default_if_none:""|safe|linebreaks  }}</small>"><a href="{% url manage_data_by_tag tag.id %}"> {{ tag.textValue }}</a></span> {% if tag.canWrite %}<a href="{% url manage_action_containers "remove" %}?parent={% if manager.image %}img-{{ manager.image.id}}{% else %}{% if manager.dataset %}ds-{{ manager.dataset.id}}{% else %}{% if manager.project %}pr-{{ manager.project.id}}{% endif %}{% endif %}{% endif %}&source=tann-{{ tag.id }}&url={{ url }}#tags_tab" onClick="return confirm('Unlink tag?');"><img src="{% url webstatic "images/cut16.png" %}" alt="u" title="unlink"/></a>{% endif %}, 
            {% endfor %}
            </h1></div>
            {% else %}
                <p>Have not been tagged yet.</p>
            {% endif %}
            
            <div class="clear"></div>
            
            {% if form_tag %}
            <div class="tags">
                <h1>{% trans "Add new tag" %}:</h1>
                <form action="#tags_tab" method="post"><input type="hidden" name="action" value="tag" />
                <table>
                    {% for field in form_tag %}
                        <tr>
                            <td></td><td colspan="2">{% if field.errors %}{{ field.errors }}{% endif %}</td>
                        </tr>
                        <tr>
                            <td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td><td>{{ field }}</td><td>{{ field.help_text|safe }}</td>
                        </tr>
                    {% endfor %}
                    <tr><td></td><td colspan="2"><input type="submit" value="{% trans 'Save' %}" /></td></tr>
                    </table>
                </form>
            </div>
            {% endif %}
            
            <div class="extags">
                <h1>{% trans "Use existing tag" %}:</h1>
                <form action="#tags_tab" method="post"><input type="hidden" name="action" value="usetag" />
                <table>
                {% for field in form_tags %}
                    <tr>
                        <td colspan="2">{% if field.errors %}{{ field.errors }}{% endif %}</td>
                    </tr>
                    <tr>
                        <td>{{ field }}</td><td>{{ field.help_text|safe }}</td>
                    </tr>
                {% endfor %}
                <tr><td colspan="2"><input type="submit" value="{% trans 'Save' %}" /></td></tr>
                </table>
                </form>
            </div>

            <div class="clear"></div>
        </div>
        
        <!-- FILES -->
        <div id="file_tab">
            <h1>{% trans "Files" %}:</h1>
            {% if manager.fileannSize %}
            <div class="lnfiles">
                {% for fileann in manager.file_annotations %}
                <p><a href="#" onClick="document.location.href='{% url manage_annotation "download" fileann.id %}';">{{ fileann.getFileName }}</a> ({{ fileann.getFileSize|default_if_none:0|filesizeformat }}) {% trans "by" %} {{ fileann.getDetails.getOwner.getInitialName }} {% trans "at" %} {{ fileann.creationEventDate|date:"Y-m-d H:i:s" }} {% if fileann.canWrite and not fileann.isOriginalMetadat %}<a href="{% url manage_action_containers "remove" %}?parent={% if manager.image %}img-{{ manager.image.id}}{% else %}{% if manager.dataset %}ds-{{ manager.dataset.id}}{% else %}{% if manager.project %}pr-{{ manager.project.id}}{% endif %}{% endif %}{% endif %}&source=fann-{{ fileann.id }}&url={{ url }}#file_tab" onClick="return confirm('Unlink file?');"><img src="{% url webstatic "images/cut16.png" %}" alt="u" title="unlink"/></a>{% endif %}</p>
                {% endfor %}
            </ol>
            </div>
            {% else %}
                <p>No file has been attached yet.</p>
            {% endif %}
            
            <div class="clear"></div>
            
            {% if form_file %}
            <div class="file">
                <h1>{% trans "Upload a new file" %}:</h1>
                <form action="#file_tab" enctype="multipart/form-data" method="post"><input type="hidden" name="action" value="file" />
                <table>
                {% for field in form_file %}
                    <tr>
                        <td colspan="2">{% if field.errors %}{{ field.errors }}{% endif %}</td>
                    </tr>
                    <tr>
                        <td>{{ field }}</td><td>{{ field.help_text|safe }}</td>
                    </tr>
                {% endfor %}
                <tr><td colspan="2"><input type="submit" value="{% trans 'Save' %}" /></td></tr>
                </table>
                </form>
            </div>
            {% endif %}

            <div class="exfile">
                <h1>{% trans "Attache existing file" %}:</h1>
                <form action="#file_tab" method="post"><input type="hidden" name="action" value="usefile" />
                <table>
                {% for field in form_files %}
                    <tr>
                        <td colspan="2">{% if field.errors %}{{ field.errors }}{% endif %}</td>
                    </tr>
                    <tr>
                        <td>{{ field }}</td><td>{{ field.help_text|safe }}</td>
                    </tr>
                {% endfor %}
                <tr><td colspan="2"><input type="submit" value="{% trans 'Save' %}" /></td></tr>
                </table>
                </form>
            </div>
            
        </div>

    </div>
    
</div>
{% endblock %}