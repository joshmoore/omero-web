{% extends "webclient/base/base_container.html" %}
{% load i18n %}
{% load markup %}
{% load custom_tags %}
{% load wikitags %}

{% block link %}
    <link rel="stylesheet" href="{% url webstatic "css/container.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/table.css" %}" type="text/css" media="screen"/>
{% endblock %}

{% block jscript %}

    <script type="text/javascript" src="{% url webstatic "javascript/jquery.cookie.js" %}"></script>
	<script type="text/javascript" src="{% url webstatic "javascript/jquery.hotkeys.js" %}"></script>
	<script type="text/javascript" src="{% url webstatic "javascript/jquery.jstree.js" %}"></script>

{% endblock %}

{% block script %}

    <script type="text/javascript" src="{% url webstatic "javascript/actions.js" %}"></script>
    <script type="text/javascript">
        $(function() 
            {
                var h = $(window).height()-200;
                $("div#tree_details").css('height', h);
                $("div#metadata_details").css('height', h+31);
                $("div#metadata_details iframe").attr('height', h+31);
                $("div#content_details").css('height', h+31);
                
                $("#dataTree").jstree({ 
            			// the list of plugins to include
            			"plugins" : [ "themes", "html_data", "ui", "crrm", "dnd", "types", "hotkeys", "contextmenu" ],
            			// Plugin configuration

            			// I usually configure the plugin that handles the data first - in this case JSON as it is most common
            			"html_data" : { 
            				// I chose an ajax enabled tree - again - as this is most common, and maybe a bit more complex
            				// All the options are the same as jQuery's except for `data` which CAN (not should) be a function
            				"ajax" : {
            					// the URL to fetch the data
            					"url" : function(n) {
            					    return n.attr ? ("{% url load_public %}"+n.attr("id").split("-")[1]+"/") : "{% url load_public %}";
            					    },
            					// this function is executed in the instance's scope (this refers to the tree instance)
            					// the parameter is the node being loaded (may be -1, 0, or undefined when loading the root nodes)
            					"data" : function (n) {
                                    return { 
                                        "view" : "tree"
            						};
                                }
            				}
            			},
            			// Using types - most of the time this is an overkill
            			// Still meny people use them - here is how
            			"types" : {
            				// I want only `drive` nodes to be root nodes 
            				// This will prevent moving or creating any other type as a root node
            				"select_limit" : -1,
            				"max_depth" : -1,
            				"max_children" : -1,
            				"valid_children" : [ "experimenter" ],
            				"types" : {
            					"experimenter" : {
            						"valid_children" : [ "share", "share-locked", "discussion", "discussion-locked" ],
            						"icon" : {
            							"image" : '{% url webstatic "images/personal16.png" %}'
            						},
            						"create_node" : false,
            						"start_drag" : false,
            						"move_node" : false,
            						"delete_node" : false,
            						"remove" : false
            					},
            					"share" : {
            						"valid_children" : [ "image", "image-locked" ],
            						"icon" : {
            							"image" : '{% url webstatic "images/folder_html16.png" %}'
            						},
            						"create_node" : false,
                                    "start_drag" : false,
            						"move_node" : false,
            						"delete_node" : true,
            						"remove" : false
            					},
            					"share-locked" : {
            						"valid_children" : [ "image", "image-locked" ],
            						"icon" : {
            							"image" : '{% url webstatic "images/folder_html_locked16.png" %}'
            						},
            						"create_node" : false,
                                    "start_drag" : false,
            						"move_node" : false,
            						"delete_node" : false,
            						"remove" : false
            					},            					
            					"discussion" : {
            						"valid_children" : "none",
            						"icon" : {
            							"image" : '{% url webstatic "images/wp_protocol16.png" %}'
            						},
            						"create_node" : false,
            						"start_drag" : false,
            						"move_node" : false,
            						"delete_node" : true,
            						"remove" : false
            					},
            					"discussion-locked" : {
            						"valid_children" :  "none",
            						"icon" : {
            							"image" : '{% url webstatic "images/wp_protocol_locked16.png" %}'
            						},
            						"create_node" : false,
            						"start_drag" : false,
            						"move_node" : false,
            						"delete_node" : false,
            						"remove" : false
            					},
            					"image" : {
            						"valid_children" : "none",
            						"icon" : {
            							"image" : '{% url webstatic "images/image16.png" %}'
            						},
            						"create_node" : false,
            						"start_drag" : false,
            						"move_node" : false,
            						"delete_node" : false,
            						"remove" : false
            					},
            					"image-locked" : {
            						"valid_children" : "none",
            						"icon" : {
            							"image" : '{% url webstatic "images/image_locked16.png" %}'
            						},
            						"create_node" : false,
            						"start_drag" : false,
            						"move_node" : false,
            						"delete_node" : false,
            						"remove" : false
            					}
            				}
            			},
            			// For UI & core - the nodes to initially select and open will be overwritten by the cookie plugin
            			// the UI plugin - it handles selecting/deselecting/hovering nodes
            			"ui" : {
            				"initially_select" : [ {% if init.initially_select %}"{{ init.initially_select }}"{% else %}"experimenter-0"{% endif %}  ]
            			},
            			// the core plugin - not many options here
            			"core" : { 
            				// just open those two nodes up
            				// as this is an AJAX enabled tree, both will be downloaded from the server
            			    "initially_open" : [ {% for p in init.initially_open %}"{{ p }}",{% endfor %} "experimenter-0" ]
            			},
            			"contextmenu" : {
            			    "select_node":true,
            			    "items" : function(obj){
            			        var config = {};        
                                
                                return config;
                            }
                        }
            			
            	})
            	.bind("select_node.jstree", function (e, data) {
            	    var oid = data.rslt.obj
            	    if(oid.attr("id").indexOf("experimenter")<0) {
            	        var cm_var = new Object();
    				    cm_var['content_details'] = {'url': null, 'rel': null, 'empty':false };
    				    cm_var['metadata_details']= {'iframe': null, 'html': null};
    				    
            	        if (oid.attr("id").indexOf("image")>=0) {
            	            if(oid.parent().parent().attr("id")!==$("div#content_details").attr('rel')) {
            	                cm_var['content_details']['url'] = '/webclient/load_public/'+oid.parent().parent().attr('id').split("-")[1]+'/?view=icon';
            	                cm_var['content_details']['rel'] = oid.parent().parent().attr("id");
            	            }
            	            cm_var['metadata_details']['iframe'] = "/webclient/metadata_details/image/"+oid.attr("id").split("-")[1]+"/"+oid.parent().parent().attr('id').split("-")[1]+"/";
            	        } else {
            	            if(oid.attr("id")!==$("div#content_details").attr('rel')) {
            	                cm_var['content_details']['url'] = '/webclient/load_public/'+oid.attr('id').split("-")[1]+'/?view=icon';
            	                cm_var['content_details']['rel'] = oid.attr("id");
            	            }
            	            cm_var['metadata_details']['iframe'] = "/webclient/metadata_details/"+oid.attr("rel").replace("-locked", "")+"/"+oid.attr("id").split("-")[1]+"/";
        	            }
        	            
        	            if (cm_var.content_details.rel!==null && cm_var.content_details.url!==null){
        	                $("div#content_details").html('<p>Loading data... please wait <img src ="{% url webstatic "images/spinner.gif" %}"/></p>');
                            $("div#content_details").load(cm_var.content_details.url);
                            $("div#content_details").attr('rel', cm_var.content_details.rel);
        	            }        	            
                        loadMetadataPanel(cm_var.metadata_details.iframe);
                    } else {
                        $("#right_panel").show();
                        $("#swapMeta").html('<img tabindex="0" src="{% url webstatic "images/spacer.gif" %}" class="collapsed-right" id="lhid_trayhandle_icon_right">');
                        $("div#metadata_details").html('<p>{% if manager.experimenter %}{{ manager.experimenter.getFullName }}{% else %}{{ eContext.user.getFullName }}{% endif %}</p>');  
                    }
        		});
            	
        	});
        
    </script>
    <script type="text/javascript">
    $(function () { 
    	$("#buttons input").click(function () {
    		switch(this.id) {
    			case "adddiscussionButton":
    			    $("#dataTree").jstree("create", null, "first", { "attr" : { "rel" : 'discussion' } });
    				break;
    			case "removecontentButton":
    			    $("#dataTree").jstree("removecontent");
    				break;
    			default:
    				$("#dataTree").jstree(this.id.replace("Button", ""));
    				break;
    		}
    	});
    });
    </script>
{% endblock %}

{% block left %}

    <div class="toolbar">
        <div id="buttons" class="align_left">
            <input class="button" type="image" src="{% url webstatic "images/reload16.png" %}" alt="Refresh" title="Refresh" onclick="document.location.href='{% url load_template nav.menu %}'">
            <input id="adddiscussionButton" class="button button-disabled" type="image" src="{% url webstatic "images/wp_protocol16.png" %}" alt="Create discussion" title="Create discussion" /> 
            <input id="deleteButton" class="button button-disabled" type="image" src="{% url webstatic "images/cancel16.png" %}" alt="Delete" title="Delete" /> 
            <input id="removecontentButton" class="button button-disabled" type="image" src="{% url webstatic "images/cancel16.png" %}" alt="Remove content" title="Remove content" /> 
        </div>
    </div>
    
</div>
<div class="clear"> </div>

<div id="tree_details">
    <div class="dataTree" id="dataTree"></div>
</div>

{% endblock %}

{% block center %}

<!--<div id="content_action"></div>
<div class="clear"> </div>-->

<div id="content_details"> </div>

{% endblock %}


{% block right %}

<div id="metadata_details">
    <iframe width="370" name="metadata_details"></iframe>
</div>


{% endblock %}



