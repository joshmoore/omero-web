{% extends "webclient/base/base.html" %}
{% load i18n %}
{% load common_filters %}

{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% block link %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static "webgateway/css/ome.table.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% static "3rdparty/jquery.tablesorter/jquery.tablesorter.css" %}" type="text/css" media="screen"/>
    
{% endblock %}

{% block script %}
    {{ block.super }}
    <script type="text/javascript" src="{% static "3rdparty/jquery.tablesorter/jquery.tablesorter.js" %}"></script>
    <script type="text/javascript" src="{% static "3rdparty/jquery.quicksearch.js" %}"></script>

    <script type="text/javascript" src="{% static "webclient/javascript/ome.webclient.actions.js" %}"></script>
    
    <script type="text/javascript">
        var isCheckedById = function(name) { 
            var checked = $("input[name='"+name+"']:checked").length; 
            if (checked == 0) { return false; } else { return true; } 
        };
        
       var manyRemoveFromBasket = function() {     
            if (!isCheckedById("image")) {//&& !isCheckedById("dataset") && !isCheckedById("plate")) {
                alert ("Please select at least one image. Currently you cannot add other objects to basket."); 
            } else { 
                var productArray = $("input[type='checkbox']:checked");
                var productListQuery = "action=delmany";
                productArray.each(function() {
                    if(this.checked) {
                        productListQuery += "&"+this.name+"="+this.id;
                    }
                });

                $.ajax({
                    type: "POST",
                    url: '{% url basket_action "update" %}', //this.href,
                    data: productListQuery,
                    contentType:'html',
                    cache:false,
                    success: function(responce){
                        if(responce.match(/(Error: ([A-z]+))/gi)) {
                            alert(responce)
                        } else {
                            window.location = '{% url basket_action %}';
                        }
                    },
                    error: function(responce) {
                        alert("Internal server error. Cannot remove from basket.")
                    }
                });
            }
        };

        function makeShare(prefix) {
            if (!isCheckedById("image")) {//&& !isCheckedById("dataset") && !isCheckedById("plate")) {
                alert ("Please select at least one image. Currently you cannot add other objects to basket."); 
            } else { 
                var productArray = $("input[type='checkbox']:checked");
                var productListQuery = "";
                if (productArray.length > 0 ) {
                    productArray.each(function() {
                        if(this.checked) {
                            productListQuery += "&"+this.name+"="+this.id;
                        }
                    });
                } else {
                    productListQuery += "&"+productArray.name+"="+productArray.id;
                }
            }

            src = prefix+'?'+productListQuery+'';
            $("#create_share_form").dialog("open");
            // load form via AJAX...
            $("#create_share_form").load(src);
            return false;
        }
        
        function makeDiscussion() {
            src = '/webclient/basket/todiscuss/';
            $("#create_discussion_form").dialog("open");
            $("#create_discussion_form").load(src);
            return false;
        }
        
        $(document).ready(function(){
            
            // since we are using 3-column layout (to extend the )
            hide_left_panel();
            
            $("#create_discussion_form").dialog({
                autoOpen: false,
                resizable: true,
                height: 470,
                width:420,
                modal: true,
                buttons: {
                    "Accept": function() {
                        // simply submit the form
                        $("#create_discussion_form").submit();
                        $( this ).dialog( "close" );
                    },
                    "Cancel": function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
            
            
            $("#create_share_form").dialog({
                autoOpen: false,
                resizable: true,
                height: 470,
                width:420,
                modal: true,
                buttons: {
                    "Accept": function() {
                        // simply submit the form
                        $("#create_share_form").submit();
                        $( this ).dialog( "close" );
                    },
                    "Cancel": function() {
                        $( this ).dialog( "close" );
                    }
                }
            });
            
            $("table#dataTable tbody").selectable({
                filter: 'tr',
                stop: function(){
                    var l = $('tr.ui-selected', this).length;
                    $("tr.ui-selected td input", this).each(function(){
                        this.checked = true;
                    });
                    if (l > 0) {
                        $("input.toggleEnabled").attr("disabled", null);
                    } else {
                        $("input.toggleEnabled").attr("disabled", "true");
                    }
                    basket_selection_changed($("tr.ui-selected td input", this));
                },
                start: function(){
                    $("tr input", this).each(function(){
                        this.checked = false;
                    });
                }
            });
            
            $("#dataTable").tablesorter( {sortList: [[1,0]]} ); 

            $('input#id_search').quicksearch('table#dataTable tbody tr', {
                'delay': 300,
                'loader': 'span.loading'
            });
        });    
    </script>

{% endblock %}

{% block center %}

<div id="content_details">
    <h1>Basket</h1>
    
    <div id="toolbar" class="toolbar_noborder">
        <input type="image" src="{% static "webclient/image/reload16.png" %}" alt="Refresh" title="Refresh" onclick="document.location.href='{% url basket_action %}';">
        <input type="image" src="{% static "webclient/image/wp_protocol16.png" %}" alt="New discussion" title="New discussion" onclick="makeDiscussion();">
        <input disabled="true" class="toggleEnabled" type="image" src="{% static "webclient/image/cut16.png" %}" alt="Remove" title="Remove" onclick="manyRemoveFromBasket();">
        <input type="image" src="{% static "webclient/image/reset.png" %}" alt="Clean" title="Clean" onclick="document.location.href='{% url empty_basket %}';">
        <input disabled="true" class="toggleEnabled" type="button" value="Create Share" title="Create a 'Share' with the selected images" onclick="makeShare('{% url basket_action 'toshare' %}');">
    </div>
    <div class="clear"> </div>

    {% if basket.sizeOfBasket %}

        <form class="quicksearch" id="quicksearch" action="#">
            <label for="id_search">Filter:</label>
            <input type="text" id="id_search">
            <span class="loading"><img class="loader" alt="Loading" src="{% static "webgateway/img/spinner.gif" %}"></span>
        </form>

        <table id="dataTable" class="tablesorter">
            <thead> 
                <tr> 
                    <th class="action">{% trans "Image" %}</th> 
                    <th class="desc">{% trans "Name" %}</th> 
                    <th class="roles">{% trans "Date" %}</th> 
                </tr> 
            </thead>
            <tbody>
                {% for c in basket.imageInBasket %}
                    <tr id="{{ c.id }}">
                        <td class="action">
                            <img src="{% url render_thumbnail_resize 32 c.id  %}" alt="image" title="{{ c.name }}"/>
                            <input type="checkbox" name="image" id="{{ c.id }}" class="hide">
                        </td>
                        <td class="desc">{{ c.name|truncatebefor:"65" }} {% if c.annotation_counter %}<img src="{% static "webgateway/img/knotes16.png" %}" alt="a" title="annotation"/>{% endif %}{% if not c.isOwned %} <img src="{% static "webclient/image/kgpg12.png" %}" alt="l" title="locked"/>{% endif %}</td>
                        <td class="roles">{{ c.getDate }}</td>                    
                    </tr>
                {% endfor %}
            </tbody>
        </table>

    {% else %}
        <p>{% trans "Basket is empty." %}</p>
    {% endif %}
</div>

<!-- hidden form for creating share - shown in dialog & loaded by AJAX -->
<form id="create_share_form" action="{% url basket_action 'createshare' %}" method="post" title="Create Share">
</form>

<!-- hidden form for creating discussion - shown in dialog & loaded by AJAX -->
<form id="create_discussion_form" action="{% url basket_action "createdisc" %}" method="post" title="Create Discussion">
</form>
    
{% endblock %}


