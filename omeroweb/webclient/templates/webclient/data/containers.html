{% extends "webclient/base/base_container.html" %}
{% load i18n %}
{% load markup %}
{% load custom_tags %}
{% load wikitags %}

{% block link %}
    <link rel="stylesheet" href="{% url webstatic "css/container.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/table.css" %}" type="text/css" media="screen"/>
{% endblock %}

{% block jscript %}

    <script type="text/javascript" src="{% url webstatic "javascript/jquery.cookie.js" %}"></script>
	<script type="text/javascript" src="{% url webstatic "javascript/jquery.hotkeys.js" %}"></script>
	<script type="text/javascript" src="{% url webstatic "javascript/jquery.jstree.js" %}"></script>   
    
{% endblock %}

{% block script %}
    
    <script type="text/javascript">
        $(function() 
            {

                var h = $(window).height()-200;
                $("div#tree_details").css('height', h);
                $("div#metadata_details").css('height', h+31);
                $("div#metadata_details iframe").attr('height', h+31);
                $("div#content_details").css('height', h+31);
                
                $("#dataTree")
            		.jstree({ 
            			// the list of plugins to include
            			"plugins" : [ "themes", "html_data", "ui", "crrm", "dnd", "types", "hotkeys", "contextmenu" ],
            			// Plugin configuration

            			// I usually configure the plugin that handles the data first - in this case JSON as it is most common
            			"html_data" : { 
            				// I chose an ajax enabled tree - again - as this is most common, and maybe a bit more complex
            				// All the options are the same as jQuery's except for `data` which CAN (not should) be a function
            				"ajax" : {
            					// the URL to fetch the data
            					"url" : "{% url load_data %}",
            					// this function is executed in the instance's scope (this refers to the tree instance)
            					// the parameter is the node being loaded (may be -1, 0, or undefined when loading the root nodes)
            					"data" : function (n) {
                                    return { 
                                        "view" : "tree", 
            							"o_type" : n.attr ? n.attr("rel") : "",
            							"o_id" : n.attr ? n.attr("id").split("-")[1] : 0
            						};
                                }
            				}
            			},
            			// Using types - most of the time this is an overkill
            			// Still meny people use them - here is how
            			"types" : {
            				// I want only `drive` nodes to be root nodes 
            				// This will prevent moving or creating any other type as a root node
            				"select_limit" : -1,
            				"max_depth" : -1,
            				"max_children" : -1,
            				"valid_children" : [ "experimenter" ],
            				"types" : {
            					"experimenter" : {
            						"valid_children" : [ "project", "dataset", "image" ],
            						"icon" : {
            							"image" : '{% url webstatic "images/tree/personal16.png" %}'
            						},
            						"create_node" : true,
            						"start_drag" : false,
            						"move_node" : false,
            						"delete_node" : false,
            						"remove" : false
            					},
            					"project" : {
            						"valid_children" : [ "dataset" ],
            						"icon" : {
            							"image" : '{% url webstatic "images/tree/folder16.png" %}'
            						},
            						"create_node" : true,
                                    "start_drag" : false,
            						"move_node" : true,
            						"delete_node" : true,
            						"remove" : true
            					},
            					"dataset" : {
            						"valid_children" : [ "image" ],
            						"icon" : {
            							"image" : '{% url webstatic "images/tree/folder_image16.png" %}'
            						},
            						"create_node" : false,
            						"start_drag" : true,
            						"move_node" : true,
            						"delete_node" : true,
            						"remove" : true
            					},
            					"image" : {
            						"valid_children" : "none",
            						"icon" : {
            							"image" : '{% url webstatic "images/tree/image16.png" %}'
            						},
            						"create_node" : false,
            						"start_drag" : true,
            						"move_node" : true,
            						"delete_node" : true,
            						"remove" : true
            					},
            					"orphaned" : {
            						"valid_children" : [ "image" ],
            						"icon" : {
            							"image" : '{% url webstatic "images/tree/folder_yellow16.png" %}'
            						},
            						"create_node" : false,
            						"start_drag" : false,
            						"move_node" : false,
            						"delete_node" : false,
            						"remove" : false
            					}          					
            				}
            			},
            			// For UI & core - the nodes to initially select and open will be overwritten by the cookie plugin

            			// the UI plugin - it handles selecting/deselecting/hovering nodes
            			"ui" : {
            				// this makes the node with ID node_4 selected onload
            				"initially_select" : [ "experimenter-0" ]
            			},
            			// the core plugin - not many options here
            			"core" : { 
            				// just open those two nodes up
            				// as this is an AJAX enabled tree, both will be downloaded from the server
            				"initially_open" : [ "experimenter-0" ] 
            			},
            			"contextmenu" : {
                            "items": {
                                "create" : {
                                    "label" : "Create new",
                                    "icon" : '{% url webstatic "images/window_new16.png" %}',
                                    "submenu": {
                                        "Project":{
                                            "label" : "Project",
                                                "action": function (obj) { 
                                                    console.log(obj)
                                                }
                                        },
                                        "Dataset":{
                                            "label" : "Dataset",
                                                "action": function (obj) { 
                                                    console.log(obj)
                                                }
                                        },
                                        "Screen":{
                                            "label" : "Screen",
                                                "action": function (obj) { 
                                                    console.log(obj)
                                                }
                                        }
                                    }
                                }
                            }
                        }
            			
            	})
            	.bind("create.jstree", function (e, data) {
            	    if(data.rslt.parent.attr("rel") == "project") {
                        url = '{% url manage_action_containers "addnewcontainer" %}project/'+data.rslt.parent.attr("id").split("-")[1]+'/';
                    } else {
                        url = '{% url manage_action_containers "addnewcontainer" %}';
                    }
                    
                    $.ajax({
                      url: url,
                      data: { 
      			          "name" : data.rslt.name,
      					  "folder_type" : data.rslt.obj.attr("rel")
      				  },
                      dataType: "json",
                      type: "POST",
                      success: function(r){
                          if(eval(r.bad)) {
      						$.jstree.rollback(data.rlbk);
      				      } else {
      				        $(data.rslt.obj).attr("id", data.rslt.obj.attr("rel")+"-"+r.id);
      				      }
                      }
                    });
        		})
        		.bind("rename.jstree", function (e, data) {
        		    url = '{% url manage_action_containers "savename" %}'+data.rslt.obj.attr("rel")+'/'+data.rslt.obj.attr("id").split("-")[1]+'/';
        		    $.ajax({
                        url: url,
                        data: { 
      			            "name" : data.rslt.new_name
                        },
                        dataType: "json",
                        type: "POST",
                        success: function(r){
                            if(eval(r.bad)) {
                                $.jstree.rollback(data.rlbk);
                            }
                        }
                    });
        		})
        		.bind("move_node.jstree", function (e, data) {
                    data.rslt.o.each(function (i) {
                        url = '{% url manage_action_containers "move" %}'+$(this).attr("rel")+'/'+$(this).attr("id").split("-")[1]+'/'
                        $.ajax({
            		        async : false,
                            url: url,
                            data : { 
          					    "parent" : data.rslt.op.attr("rel")+'-'+data.rslt.op.attr("id").split("-")[1], 
          						"destination" : data.rslt.np.attr("rel")+'-'+data.rslt.np.attr("id").split("-")[1]
          					},
                            dataType: "json",
                            type: "POST",
                            success: function(r){
                                if(eval(r.bad)) {
          							$.jstree.rollback(data.rlbk);
          						}
          						else {
          							$(data.rslt.oc).attr("id", $(this).attr("rel")+"-"+r.id);
          							if(data.rslt.cy && $(data.rslt.oc).children("UL").length) {
          								data.inst.refresh(data.inst._get_parent(data.rslt.oc));
          							}
          						}
          						$("#analyze").click();
                            }
                        });
                    }); 
        		});            		           
        });       
        
    </script>
    <script type="text/javascript" src="{% url webstatic "javascript/actions.js" %}"></script>
    
{% endblock %}

<!-- Add a user-chooser to the toolbar -->
{% block toolbar %}
    {% if form_users %}
    <div style="float:left; padding: 0px 10px">
        {% for field in form_users %}{{ field }}{% endfor %}&nbsp;&nbsp;&nbsp;
    </div>
    {% endif %}
{% endblock %}

{% block left %}

    <div class="toolbar">
        <div id="buttons" class="align_left">
            <input class="button" type="image" src="{% url webstatic "images/reload16.png" %}" alt="Refresh" title="Refresh" onclick="document.location.href='{% url load_template nav.menu %}'"> <input class="button" type="image" src="{% url webstatic "images/view_tag16.png" %}" alt="Tags" title="Tags" onclick="document.location.href='{% url load_template "usertags" %}'">
        </div>
    </div>

<div class="clear"> </div>

<div id="tree_details">
    <div class="dataTree" id="dataTree"></div>
</div>

{% endblock %}

{% block center %}

<div id="content_details"> </div>

{% endblock %}


{% block right %}

<div id="metadata_details">
    <iframe width="370" name="metadata_details"></iframe>
</div>


{% endblock %}



