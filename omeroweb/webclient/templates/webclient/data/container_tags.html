{% extends "webclient/base/base_main.html" %}
{% load i18n %}
{% load markup %}
{% load custom_tags %}
{% load wikitags %}

{% block link %}
    <link rel="stylesheet" href="{% url webstatic "css/container.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/thickbox.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/annotation.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/table.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/autocomplete.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/tooltip.css" %}" type="text/css" media="screen"/>
{% endblock %}

{% block jscript %}    
    <script type="text/javascript" src="{% url webstatic "javascript/jquery.tooltip.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/jquery.dimensions.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/jquery.delegate.js" %}"></script>
    
    <script type="text/javascript" src="{% url webstatic "javascript/jquery.bgiframe.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/jquery.ajaxQueue.js" %}/"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/jquery.autocomplete.js" %}"></script>
    
    <script type="text/javascript" src="{% url webstatic "javascript/ui/ui.core.js" %}"></script>
    
    <script type="text/javascript" src="{% url webstatic "javascript/thickbox/thickbox.js" %}"></script>
{% endblock %}


{% block script %}
    <script type="text/javascript" src="{% url webstatic "javascript/actions.js" %}"></script>
    
        
    <script type="text/javascript">
        $(document).ready(function() 
            {                 
                $("div#tag").hide();
                $("div#tagloader").html('<p>{% trans "Loading filters... please wait" %} <img src ="{% url webstatic "images/tree/spinner.gif" %}"/></p>');
                
                $.ajax({  
                    type: "GET",  
                    url: "{% url autocomplete_tags %}",  
                    contentType: "application/json; charset=utf-8",  
                    cache:false,
    				async: false,
    				dataType: "json",  
                    success: function(json){  
                        prepareAutocomplete(json);
                        $("div#tagloader").remove();
                        $("div#tag").show();
                    },  
                    error: function(xhr, msg){  
                        alert("{% trans 'Could not load tag component. Please contact Administrator.' %}");  
                    }
                });
                
                function prepareAutocomplete(myjson){
                    $("#id_tag, #id_tag2, #id_tag3, #id_tag4, #id_tag5").autocomplete(myjson, {
                        //width: 320,
                        max: 10,
                        scroll: true,
                        scrollHeight: 200,
                        highlightItem: true,
                        //multiple: true,
                        //multipleSeparator: ";",
                        formatItem: function(row, i, max, term) {
                            if(row.desc!=null) {
                                return row.tag + "<br/><small>" + row.desc + "</small>";
                            } else {
                                return row.tag
                            }
                        },
                        formatMatch: function(row, i, max) {
                            return row.tag + " " + row.id;
                        },
                        formatResult: function(row) {
                            return row.tag;
                        }
                    });
                }
                
                $("{% for t in manager.tags %}#tagdesc{{ t.id }}, {% endfor %}#tag").tooltip({ 
                    track: true, 
                    delay: 0, 
                    showURL: false, 
                    opacity: 1, 
                    fixPNG: true, 
                    showBody: " - ", 
                    top: -15, 
                    left: 5 
                });
                
                $("{% for t in manager.tags %}#tagicons{{ t.id }}, {% endfor %}#tag").tooltip({ 
                    track: true, 
                    delay: 0, 
                    showURL: false, 
                    opacity: 1, 
                    fixPNG: true, 
                    showBody: " - ", 
                    top: -15, 
                    left: 5 
                });
                $("{% for t in manager.tags %}#tagtables{{ t.id }}, {% endfor %}#tag").tooltip({ 
                    track: true, 
                    delay: 0, 
                    showURL: false, 
                    opacity: 1, 
                    fixPNG: true, 
                    showBody: " - ", 
                    top: -15, 
                    left: 5 
                });
        })
    </script>

{% endblock %}

{% block top %}

<div class="tag">
    <h1>{% trans "Tags" %}:</h1>
    <p>{% trans "That page allows you to display the data by tags. Please start typing tag and choose correct tag from auto-complete list. You can choose from 1 to 5 tags. Filter will show you ever data associated with those tags." %}</p>
</div>

<div>
    {% if manager.tags %}
    <h1>{% trans "Selected tags" %}:</h1>
    {% endif %}
    <div id="tagloader"></div>
    <div id="tag">
        {% if form_filter %}
        <form action="" method="post">
        <table>
            <tr>
                {% for t in manager.tags %}
                <td>{% if t %}
                    <span id="tagdesc{{ t.id }}" title="{{ t.textValue }} - <small>{{ t.description|default_if_none:"no description"|safe|linebreaks  }}</small>"><a>{{ t.shortTag }}</a></span>{% if not t.isOwned %}<img src="{% url webstatic "images/kgpg16.png" %}" alt="l" title="locked"/>{% endif %} {% if t.isEditable %}<a href="{% url manage_action_containers "edit" "tag" t.id %}?url={{url}}"><img src="{% url webstatic "images/color_line16.png" %}" alt="e" title="edit"/></a>{% endif %}
                {% else %}
                    <ul class="errorlist"><li>{% trans "This tag does not exist." %}</li></ul>
                {% endif %}</td><td> </td>
                {% endfor %}
                <td> </td>
            <tr>
                <td>{{ form_filter.tag }}</td><td>{% if form_filter.tag.errors %}{{ form_filter.tag.errors }}{% endif %}<br/>{{ form_filter.tag.help_text|safe }}</td>
                <td>{{ form_filter.tag2 }}</td><td>{% if form_filter.tag2.errors %}{{ form_filter.tag2.errors }}{% endif %}<br/>{{ form_filter.tag2.help_text|safe }}</td>
                <td>{{ form_filter.tag3 }}</td><td>{% if form_filter.tag3.errors %}{{ form_filter.tag3.errors }}{% endif %}<br/>{{ form_filter.tag3.help_text|safe }}</td>
                <td>{{ form_filter.tag4 }}</td><td>{% if form_filter.tag4.errors %}{{ form_filter.tag4.errors }}{% endif %}<br/>{{ form_filter.tag4.help_text|safe }}</td>
                <td>{{ form_filter.tag5 }}</td><td>{% if form_filter.tag5.errors %}{{ form_filter.tag5.errors }}{% endif %}<br/>{{ form_filter.tag5.help_text|safe }}</td>
                <td><input type="submit" value="Filter" /></td>
            </tr>
        </table>
        </form>
        {% endif %}
    </div>
</div>

<div class="separate70"></div>

{% endblock %}

{% block left %}

<!--content-->
<div>
    <div class="tagcontent">
        {% include "webclient/container_tags_icon.html" %}
    </div>
    
    {% include "webclient/container_paging.html" %}
    
</div>

{% endblock %}

{% block right %}

    <iframe width="100%" height="680" name="metadata_details"></iframe>

{% endblock %}

{% block linked %}

<!--where is it-->
{% if manager.dataset or manager.project or manager.plate or manager.screen %}
<div id="linked">
    {% if manager.dataset %}
        <h1>{% trans "Where this dataset is linked?" %}</h1>
    {% else %}
        {% if manager.project %}
            <h1>{% trans "Where this project is linked?" %}</h1>
        {% else %}
            {% if manager.plate %}
                <h1>{% trans "Where this plate is linked?" %}</h1>
            {% else %}
                {% if manager.screen %}<h1>{% trans "Where this screen is linked?" %}</h1>{% endif %}
            {% endif %}
        {% endif %}
    {% endif %}
    <a href="#" class="loadingData">{% trans "Show the hierarchy structure" %}...</a>
</div>
<div id="hierarchy"></div>
{% endif %}

{% endblock %}
