{% load i18n %}
{% load common_filters %}

{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

    <script type="text/javascript">

        INITIAL_ICON_SIZE = 65;

        var handleRemove = function (e, data) {
            var content_id = $("#content_details").attr("rel");     // content, E.g. 'dataset-123'
            data.rslt.obj.each(function() {
                // if we're removing the current dataset...
                if (content_id == $(this).attr('id')) {
                    $("#content_details").remove();
                } else if ($(this).attr('id').split("-")[0] == "image") {
                    // else, remove image
                    var imgId = $(this).attr('id').split("-")[1];
                    $("ul#dataIcons li [id='" + imgId + "']").parent().remove();
                }
            });
        };
        
        $(document).ready(function(){
            
            var $parent_container = $("#content_details");

            // Handle zooming of thumbnails with jQuery slider
            var icon_styles = [];
            var li_styles = [];
            var aspect_ratios = [];
            // manipulate thumbnail styles directly (approx 2x faster than using jQuery)
            $("#dataIcons img").each(function(){
                icon_styles.push(this.style);
            });

            var sizeX, sizeY
            $("#dataIcons tr").each(function(){
                li_styles.push(this.style);
                sizeX = $(".sizeX", $(this)).text();
                sizeY = $(".sizeY", $(this)).text();
                aspect_ratios.push(parseFloat(sizeX) / parseFloat(sizeY));
            });
            var setIconSize = function(icon_size) {
                for (s in icon_styles) {
                    if (aspect_ratios[s] < 1) {
                        icon_styles[s].width = (icon_size * aspect_ratios[s]) >> 0 + "px";
                        icon_styles[s].height = icon_size + "px";
                    } else if (aspect_ratios[s] > 1) {
                        icon_styles[s].height = (icon_size / aspect_ratios[s]) >> 0 + "px";
                        icon_styles[s].width = icon_size + "px";
                    } else {
                        icon_styles[s].width = icon_size + "px";
                        icon_styles[s].height = icon_size + "px";
                    }
                    li_styles[s].width = icon_size + "px";
                    li_styles[s].height = icon_size + "px";
                }
            }
            $("#thumb_size_slider").slider({
                max: 200,
                min: 30,
                value: INITIAL_ICON_SIZE,
                slide: function(event, ui) {
                    setIconSize(ui.value);
                }
            });
            
            setIconSize(INITIAL_ICON_SIZE);
            
            // when the jstree removes objects from the tree, handle each object...
            $("#dataTree").bind("remove.jstree", handleRemove);     // NB: this binds repeatedly each time this page loads
            
            var datatree = $.jstree._focused();
            
            // double-click handler on image - launches image viewer
            $("#dataIcons img").dblclick(function(event) {
                openPopup("{% url web_image_viewer 0 %}".replace('0', parseInt( $(this).attr('id') )));
            });
            
            // single click handler on image (container). Selection then update toolbar & metadata pane
            $("#dataIcons tr").click(function(event) {
                handleClickSelection(event);
            });
            
            // handles selection for 'clicks' (not drags) 
            var handleClickSelection = function(event) {
                var parent_id = '#'+$('#content_details').attr('rel');
                var targetId = $(event.target).attr('id');      // target could be img, etc
                var $tr;
                if (event.target.nodeName.toLowerCase() == 'tr') {
                    $tr = $(event.target);
                } else if (event.target.nodeName.toLowerCase() == 'img') {
                    $tr = $(event.target).parent().parent();
                } else {
                    $tr = $(event.target).parent();
                }
                var select_id = "image-" + $tr.attr('id').split("-")[1];
                // find the matching child node from the tree
                var $children = datatree._get_children(parent_id);
                var toSelect = $children.filter(function(index) {
                    return ($(this).attr('id') == select_id);
                });
                // In case image not in tree (out of sync?), we refresh tree
                if (toSelect.length == 0) {
                    datatree.deselect_all();
                    datatree.select_node(parent_id);
                    datatree.refresh(parent_id);
                } else {
                    // tree handles control/shift clicks for multi-select
                    datatree.select_node(toSelect, true, event);
                    return false;
                }
            }
            
            // plugin to handle drag-select of images
            $("#dataIcons").selectable({
                filter: 'tr',
                distance: 2,
                stop: function(){  
                    
                    // get the image ids from the thumbnails
                    var toSelectIds = new Array();
                    $("tr.ui-selected", this).each(function(i){
                        var iId = $(this).attr('id').split("-")[1];
                        toSelectIds[i] = "image-"+iId;
                    });
                    
                    // find the matching child nodes from the tree
                    var $children = datatree._get_children('#'+$('#content_details').attr('rel'));
                    var toSelect = $children.filter(function(index) {
                        return ($.inArray($(this).attr('id'),toSelectIds)!=-1);
                    });

                    // we want to manually select a bunch of nodes, firing only a single selection event (when we're done)
                    datatree.data.ui.selected.children("a").removeClass("jstree-clicked");
                    // choose the first of our selection
                    var $first = toSelect.first();
                    toSelect = toSelect.slice(1);   // the rest
                    // manually select all apart from the first
                    datatree.data.ui.selected = toSelect;
                    toSelect.children("a").addClass("jstree-clicked");
                    // select the first (triggers selection event)
                    datatree.select_node($first);
                },
                start: function(){
                }
            });

            // switch between 'icon' or 'table' layout by switching CSS
            var setLayout = function(layout) {
                if (layout == "icon"){
                    $("#dataIcons").removeClass("tableLayout");
                    $("#dataIcons").addClass("iconLayout");
                }
                else {
                    $("#dataIcons").removeClass("iconLayout");
                    $("#dataIcons").addClass("tableLayout");
                }
            }
            // handle Radio buttons 
            $("#layout_chooser input").click(function() {
                var layout = $("#layout_chooser input:checked").attr('value');
                setLayout(layout);
                $parent_container.data('layout', layout);   // preserve state for new datasets
            });
            // check if we've previously set layout - if so, configure UI accordingly
            var existing_layout = $parent_container.data('layout');
            if (existing_layout) {
                setLayout(existing_layout);
                $("#layout_chooser input[value='"+ existing_layout + "']").attr('checked', 'true');
            }

            // Handle zooming of thumbnails with jQuery slider
            var icon_styles = [];
            var li_styles = [];
            // manipulate thumbnail styles directly (approx 2x faster than using jQuery)
            $("#dataIcons img").each(function(){
                icon_styles.push(this.style);
            });
            $("#dataIcons tr").each(function(){
                if (! $(this).hasClass('thead')) {
                    li_styles.push(this.style);
                }
            });
            var setIconSize = function(size) {
                for (s in icon_styles) {
                    // have to set 'max' size to maintain aspect ratio BUT can't go bigger than 100%
                    icon_styles[s].maxWidth = size + "px";
                    icon_styles[s].maxHeight = size + "px";
                    li_styles[s].width = size + "px";
                    li_styles[s].height = size + "px";
                }
            }
            $("#thumb_size_slider").slider({
                max: 200,
                min: 30,
                value: 65,
                slide: function(event, ui) {
                    setIconSize(ui.value);
                    $parent_container.data('icon_size', ui.value);   // preserve icon size for new datasets
                }
            });
            // check if we've previously set icon size - if so, configure UI accordingly
            var existing_icon_size = $parent_container.data('icon_size');
            if (existing_icon_size) {
                setIconSize(existing_icon_size);
                $("#thumb_size_slider").slider('value', existing_icon_size);
            }

            $('input#id_search').quicksearch('#dataIcons tbody tr', {
                'delay': 300,
                'loader': 'span.loading'
            });

        });

    </script>
    <style type="text/css">
        #thumb_size_slider {
            border: 1px solid #aaa;
            height: 6px;
            right: 150px;
            position: absolute;
            top: 9px;
            width: 120px;
        }
        #thumb_size_slider .ui-slider-handle {
            /*background: -moz-linear-gradient(center top , #727C86 0%, #4F565D 100%) repeat scroll 0 0 #FFFFFF;*/
            background: #727C86;
            border-radius: 3px;
        }

        .sizeX, .sizeY {display:none}
        
        .iconLayout tr {
            float: left;
            padding: 5px;
        }
        .iconLayout td.desc, .iconLayout td.date, .iconLayout tr.thead {
            display: none;
        }
        .iconLayout tr {
            background-color:hsl(0,0%,95%);
            margin:5px;
            padding:5px;
            width: 65px;
            height: 65px;
            background-color: #F2F2F2;
            border: 1px solid white;
            border-radius: 2px 2px 2px 2px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        .tableLayout {
            position: relative;
            width: 100%;
        }
        .tableLayout td.desc, .tableLayout td.date {
            padding: 10px 0px;
            font-size: 1.2em;
            vertical-align: middle;
        }
        .tableLayout td.image {
            padding: 5px;
        }
        .tableLayout tbody tr:nth-child(2n) {
            background-color: #EFEFF0;
        }
        .tableLayout tbody tr:nth-child(2n) {
            background-color: #EFEFF0;
        }

    </style>

<div style="position:absolute; top:0px; left:0px; right:0px; height: 25px; border-right:0px" class="toolbar">
    <div id="thumb_size_slider" title="Zoom Thumbnails"></div>
    
    <div id="layout_chooser" style="position: absolute;right: 20px;">
        Icon <input type="radio" name="layout" value="icon" checked='true'>
        Table <input type="radio" name="layout" value="table">
    </div>

    <form class="quicksearch" id="quicksearch" action="#"><label for="id_search">Filter:</label> <input type="text" id="id_search" value=""> <span class="loading"><img class="loader" alt="Loading" src="{% static "webgateway/img/spinner.gif" %}"></span></form>
    
</div>

<div style="position:absolute; top:25px; left:0px; bottom:0px; overflow:auto; margin-top:0px; right:0px">
{% if manager.containers.images %}

    
    <table id="dataIcons" class="tablesorter iconLayout">
        <thead> 
            <tr class="thead"> 
                <th class="table_images">{% trans "Images" %}</th> 
                <th class="table_desc">{% trans "Name" %}</th> 
                <th class="table_date">{% trans "Date" %}</th> 
                <th>{% trans "Size X" %}</th> 
                <th>{% trans "Size Y" %}</th> 
            </tr> 
        </thead>
        <tbody>
            {% for c in manager.containers.images %}
                <tr id="image_row-{{ c.id }}">
                    <td class="image" title="{{ c.name }}">
                        <img id="{{ c.id }}" src="{% url render_thumbnail_resize 200 c.id %}" alt="image" title="{{ c.name }}{% if not c.isOwned %}, owned by {{ c.getOwner.getNameWithInitial }}{% endif %}"/>
                    </td>
                    <td class="desc" valign="middle">{{ c.name|truncatebefor:"65" }}</td>
                    <td class="date" valign="middle">{{ c.getDate }}</td>                    
                    <td class="sizeX">{{ c.getSizeX }}</td>
                    <td class="sizeY">{{ c.getSizeY }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% include "webclient/data/container_paging.html" %}
    
{% else %}
    <p class="center_message no_data" title="Tip: Use OMERO.insight client to import some images">{% trans "No images in Dataset" %}</p>
{% endif %}
</div>

