{% load i18n %}
{% load common_tags %}

{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% ifnotequal nav.menu "status" %}
<script>
    
    jQuery.fn.alternateRowColors = function() {
        var $rows = $(this).children().children('tr');
        $rows.not('.hidden').filter(':odd').removeClass('even').addClass('odd');
        $rows.not('.hidden').filter(':even').removeClass('odd').addClass('even');
      return this;
    };
    
    var showActivities = function() {
        //activities_Window = popupActivites('{% url status %}');
        $("#activities_panel").toggle();
        if ($("#activities_panel").is(":visible")) {
            $("#activities_content").prepend( $('<img src="{% static "common/image/spinner.gif" %}"/>') );
            refreshActivities();
        }
    }
    
    var setupResultOptions = function() {
        $(".result").children('a').click(function(e){
            console.log('show menu');
            $(this).parent().find('ul').css('visibility', 'visible');
            e.preventDefault();
            return false;
        });
        // on hover-out of the menu itself, hide drop-down menus
        $(".resultOptions").hover(function(){}, function(){
            $(this).css('visibility', 'hidden');
        });

        //$(".script_error input[type='submit']").click(submitError);
    }

    // this is called by the setInterval loop below
    var activitiesUpdate = function(i) {
        $.get("{% url activities %}", function(data) {
            var inprogress = $("#inprogress", data).text();
            if ((typeof inprogress == 'undefined') || (inprogress.length == 0)) {
                console.log(inprogress, 'stopping');
                if (i != undefined) clearInterval(i);
                return;
            }
            inprogress = parseInt( inprogress );
            var failure = $("#failure", data).text();
            console.log(inprogress);
            if (inprogress==0) {
                if (i != undefined) clearInterval(i);
                $("#progress").hide();
                if(failure>0) {
                    $("#jobstatus").html(failure + ' job(s) failed');
                } else {
                    $("#jobstatus").html('0 job(s)');
                }
            }
            else {
                $("#progress").show();
                $("#jobstatus").html(inprogress + ' job(s) in progress');
            }
            $("#activities_content").empty()
            $("#activities_content").append( $("table", data) );
            $("#jobsTable").alternateRowColors();
            setupResultOptions();
            $(".remove").click(function() {
                var jobKey = this.id;
                var $jobRow = $(this).parent().parent();
                $.ajax({
                    type: "POST",
                    url: "{% url status 'clean' %}",
                    data: {'jobKey':jobKey},
                    contentType:'json',
                    success: function(r){
                         $jobRow.remove();
                         $("#jobsTable").alternateRowColors();
                    },
                    error: function(r){}
                });

            });
        });
    }

    var refreshActivities = function() {
        activitiesUpdate();
        var i = setInterval(function (){
                activitiesUpdate(i);
        }, 5000);
    }
    $(document).ready(function() {
        refreshActivities();
        $("#activities_panel").hide();
    });
</script>

{% endifnotequal %}

        {% ifnotequal nav.menu "basket" %}
        <div id="baskets"><a href="{% url basket_action %}">{% trans "BASKET:" %}</a> <span id="cartTotal">{{ nav.basket }}</span> {% plural nav.basket 'item' 'items' %}</div>
        {% endifnotequal %}
        {% ifnotequal nav.menu "status" %}
        <div id="queue">
            <a href="#" onClick="showActivities();" class="align_left">ACTIVITIES:</a>
            <div id="jobstatus">0 job(s)</div>
            <img src="{% static "common/image/spinner.gif" %}" id="progress" style="display: none;"/>
            
            <div id="activities_panel">
                <div>
                    Activities
                </div>
                
                <div id="activities_content">
                </div>
                
            </div>
        </div>
        {% endifnotequal %}
