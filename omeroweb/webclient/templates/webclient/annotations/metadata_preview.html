{% load i18n %}


{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

    <link rel="stylesheet" href="{% static "webclient/css/layout.css" %}" type="text/css" media="screen"/>

    <link rel="stylesheet" type="text/css" href="{% static "3rdparty/panojs/panojs.css" %}" media="all" />

    <link rel="stylesheet" href="{% static "webgateway/css/ome.gs_slider.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% static "webgateway/css/ome.viewport.css" %}" type="text/css" media="screen"/>


    <script type="text/javascript">
        $(document).ready(function() {

            // Fix size according to right panel size... NB: this behaviour is also in right_plugin.preview.js
            var vpWidth = $("#right_panel").width() - 50,
              vpHeight = Math.min(vpWidth, $("#preview_tab").height() - 100);
            vpHeight = Math.max(300, vpHeight);
            $("#viewport").css({'width': vpWidth + 'px', 'height': vpHeight + 'px'});

            /**
             * Gets called when an image is initially loaded.
             * This is the place to sync everything; rendering model, quality, channel buttons, etc.
             */
            var _refresh_cb = function (ev, viewport) {
              /* Sync inputs with initial values */

              $('#wblitz-rmodel').attr('checked', !viewport.isGreyModel());
              $('#wblitz-invaxis').attr('checked', viewport.loadedImg.rdefs.invertAxis);
              //$('#rd-wblitz-rmodel').attr('checked', !viewport.isGreyModel());

              var q = viewport.getQuality();
              if (q) {
                var qr = $('#wblitz-quality > [value="+q.toFixed(1)+"]');
                if (qr.length) {
                  qr.attr('selected','selected');
                }
              }

              /* Prepare the channels box and the rendering definition for the channels */
              var box = $('#wblitz-channels-box');
              var channels = viewport.getChannels();
              box.empty();
              for (i=0; i<channels.length; i++) {
                box.append('<button id="wblitz-ch'+i+'"\
                           class="squared' + (channels[i].active?' pressed':'') + '"\
                           style="background-color: #'+channels[i].color+'"\
                           title="'+channels[i].label+'"\
                           onclick="viewport.toggleChannel('+i+')">'+channels[i].label+'</button>');

              }

              // disable 'split' view for single channel images.
              if (channels.length < 2) {
                $("input[value='split']").attr('disabled', 'disabled');
              }

              /* Image details */
              var tmp = getMetadata();
              $('#wblitz-image-name').html(tmp.imageName);
              $('#wblitz-image-description-content').html(tmp.imageDescription.replace(/\n/g, '<br />'));
              $('#wblitz-image-author').html(tmp.imageAuthor);
              $('#wblitz-image-pub').html(tmp.projectName);
              $('#wblitz-image-pubid').html(tmp.projectId);
              $('#wblitz-image-timestamp').html(tmp.imageTimestamp);

              $("#bulk-annotations").hide();
              $("#bulk-annotations").next().hide();
              if (tmp.wellId) {
                  // Load bulk annotations for plate
                  var onAnnotations = function(result) {
                      if (result.data && result.data.rows) {
                          var table = $("#bulk-annotations").show().next().show().children("table");
                          for (var col in result.data.columns) {
                              var label = result.data.columns[col];
                              var value = '';
                              for (var row in result.data.rows) {
                                  value += result.data.rows[row][col] + '<br />';
                              }
                              var row = $('<tr><td class="title"></td><td></td></tr>');
                              row.addClass(col % 2 == 1 ? 'odd' : 'even');
                              $('td:first-child', row).html(label + ":&nbsp;");
                              $('td:last-child', row).html(value);
                              table.append(row);
                          }
                      }
                  };
                  $.getJSON('{% url 'webgateway_object_table_query' 'Plate.wells' 999 %}'.replace('999', tmp.wellId) +
                      '?query=Well-' + tmp.wellId +
                      '&callback=?',
                       onAnnotations);
                  $.getJSON('{% url 'webgateway_object_table_query' 'Screen.plateLinks.child.wells' 999 %}'.replace('999', tmp.wellId) +
                      '?query=Well-' + tmp.wellId +
                      '&callback=?',
                       onAnnotations);
              }

              {% block xtra_metadata %}{% endblock %}

              /*$('#wblitz-shortname').attr('title', tmp.imageName).html(gs_text_trim(tmp.imageName, 15, true));*/

              tmp = viewport.getSizes();
              $('#wblitz-image-width').html(tmp.width);
              $('#wblitz-image-height').html(tmp.height);
              $('#wblitz-image-z-count').html(tmp.z);
              $('#wblitz-image-t-count').html(tmp.t);
              tmp = viewport.getPixelSizes();
              $('#wblitz-image-pixel-size-x').html(tmp.x==0?'-':(tmp.x.lengthformat()));
              $('#wblitz-image-pixel-size-y').html(tmp.y==0?'-':(tmp.y.lengthformat()));
              $('#wblitz-image-pixel-size-z').html(tmp.z==0?'-':(tmp.z.lengthformat()));

              /* Fill in the Rendering Details box */

              $(".picker").unbind('prepared').unbind('showing').unbind('hiding');
              $('#rdef-postit ul').not('ul:last-child').remove();

              var template = '<tr class="$cls">'
                + '<td><input id="rd-wblitz-ch$idx0" type="checkbox" onchange="rdChanSelHelper(this)" $act></td>'
                + '<td>$cwl</td>'
                + '<td><button id="wblitz-ch$idx0-color" class="picker squarred">&nbsp;</button></td>'
                + '<td class="picker-selected">&nbsp;</td></tr>'
                + '<tr class="$cls rdef-window">'
                  + '<td colspan="5"><div id="wblitz-ch$idx0-cw" class="rangewidget"></div></td>'
                  +'</tr>'
                + '<tr class="$cls rdef-window">'
                  + '<td colspan="5"><div class="rangeslider" id="wblitz-ch$idx0-cwslider"></div></td>'
                  + '</tr>';

              tmp = $('#rdef-postit table tr:first');
              tmp.siblings().remove();
              for (i=channels.length-1; i>=0; i--) {
                tmp.after(template
                .replace(/\$act/g, channels[i].active?'checked':'')
                .replace(/\$idx0/g, i) // Channel Index, 0 based
                .replace(/\$idx1/g, i+1) // Channel Index, 1 based
                .replace(/\$cwl/g, channels[i].label) // Wavelength
                .replace(/\$cls/g, i/2!=parseInt(i/2)?'even':'odd') // class
                );
                $('#wblitz-ch'+(i)+'-cw').rangewidget({
            min: channels[i].window.min,
            max: channels[i].window.max,
                  template: '<span class="min">min: $min</span> $start - $end <span class="max">max: $max</span>',
                  lblStart: '',
                  lblEnd: ''});
                $('#wblitz-ch'+i+'-cwslider').slider({
                  range: true,
                  min: Math.min(channels[i].window.min, channels[i].window.start+1),  // range may extend outside min/max pixel
                  max: Math.max(channels[i].window.max, channels[i].window.end-1),
                  values: [ channels[i].window.start+1, channels[i].window.end-1 ],
                  slide: function(event, ui) {
                    $('#wblitz-ch'+$(event.target).data('channel-idx')+'-cw-start').val(ui.values[0]).change();
                    $('#wblitz-ch'+$(event.target).data('channel-idx')+'-cw-end').val(ui.values[1]).change();
                  }
                  }).data('channel-idx', i);
                cb = function (i) {
                  return function (e) {
                    var new_start = e.target.value,
                        $sl = $('#wblitz-ch'+i+'-cwslider'),
                        end = $sl.slider('values')[1]
                        min = $sl.slider( "option", "min" );
                    $sl.slider('values', 0, Math.min(new_start, end));    // ensure start < end
                    $sl.slider( "option", "min", Math.min(min, new_start) );   // extend range if needed
                    show_change($('#wblitz-ch'+i+'-cw-start').get(0), channels[i].window.start, 'changed');
                  };
                }
                $('#wblitz-ch'+i+'-cw-start').val(channels[i].window.start).unbind('change').bind('change', cb(i));
                cb = function (i) {
                  return function (e) {
                    var new_end = e.target.value,
                        $sl = $('#wblitz-ch'+i+'-cwslider'),
                        start = $sl.slider('values')[0]
                        max = $sl.slider( "option", "max" );
                    $sl.slider('values', 1, Math.max(new_end, start));    // ensure end > start
                    $sl.slider( "option", "max", Math.max(max, new_end) );   // extend range if needed
                    show_change($('#wblitz-ch'+i+'-cw-end').get(0), channels[i].window.end, 'changed');
                  };
                }
                $('#wblitz-ch'+i+'-cw-end').val(channels[i].window.end).unbind('change').bind('change', cb(i));
              }


              /* Prepare color picker buttons */
              $(".picker")
                .colorbtn()
                .bind('showing', function () {
                    var t = $(this).parents('.postit');
                    var offset = t.offset();
                    offset.left += t.width();
                    $('#cbpicker-box').css(offset);
                    $('.picker-selected').html('&nbsp;');
                    $(this).parent().siblings('.picker-selected').html('&gt;');
                })
                .bind('hiding', function () {$(this).parent().siblings('.picker-selected').html('&nbsp;')})
                .bind('prepared', function () {
                  zindex_automator('.postit', 210, $('#cbpicker-box'));
                })
                .bind('changed', function () {
                    $("#rd-wblitz-rmodel").attr('checked', true);     // if we're updating color - show color (not greyscale)
                  $(this).parents('tr:first').next().find('.ui-slider-range').css('background-color', $(this).css('background-color'));
                });

              projectionChange(null,null, true);

              modelChange();
              syncRDCW();
                  
              $('#wblitz-workarea > .box > div.row').show();
            };

            if (typeof OME === "undefined") {OME = {}}

            {% if share_id %}
            OME.preview_viewport = $.WeblitzViewport($("#viewport"), "{% url 'webindex' %}{{ share_id }}", {'mediaroot': '{{ STATIC_URL }}' } );
            OME.preview_viewport.bind('imageLoad', _refresh_cb);
            OME.preview_viewport.load({{ manager.image.id }}, null, location.search);
            {% else %}
            OME.preview_viewport = $.WeblitzViewport($("#viewport"), "{% url 'webindex' %}", {'mediaroot': '{{ STATIC_URL }}' } );
            OME.preview_viewport.bind('imageLoad', _refresh_cb);
            OME.preview_viewport.load({{ manager.image.id }});
            {% endif %}

            var copy_paste_rdef_url = "{% url 'webgateway.views.copy_image_rdef_json' %}";
            $(".btn.copy_rdef").click(function() {
                $.getJSON(copy_paste_rdef_url + "?fromid={{ manager.image.id }}");
            });

            $(".btn.paste_rdef").click(function() {
                $.getJSON(copy_paste_rdef_url + "?toids={{ manager.image.id }}", function(data){
                    // update thumbnails
                    OME.refreshThumbnails({{ manager.image.id }});
                });
            });

        });
    </script>


<!-- VIEWER "Preview"-->
<div class="right_tab_inner">
	
<!-- open-image link -->

			<button class="btn silver btn_text" href="#" onclick="return OME.openPopup('{% if share_id %}{% url 'web_image_viewer' share_id manager.image.id %}{% else %}{% url 'web_image_viewer' manager.image.id %}{% endif %}')" alt="View" title="Open full viewer">
				<span>
                {% trans "Launch full viewer" %} 
				</span>
			</button>



    <div class="miniview" id="viewport">
    </div>

    <div style="clear:both"></div>

    <hr>

    <span id="wblitz-channels-box"></span>

    <hr>

    Rendering Settings:
    <button class="btn silver btn_text copy_rdef" title="Copy Rendering Settings">
        <span>Copy</span>
    </button>

    <button class="btn silver btn_text paste_rdef" title="Paste Rendering Settings">
        <span>Paste</span>
    </button>

</div>
