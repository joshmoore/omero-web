{% load i18n %}


{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

    <link rel="stylesheet" href="{% static "webclient/css/layout.css" %}" type="text/css" media="screen"/>

    <link rel="stylesheet" type="text/css" href="{% static "3rdparty/panojs/panojs.css" %}" media="all" />

    <link rel="stylesheet" href="{% static "webgateway/css/ome.gs_slider.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% static "webgateway/css/ome.viewport.css" %}" type="text/css" media="screen"/>

    <style>
      /*from omero_image.css*/
      .ui-slider-handle.ui-state-default {
        background: #FEE7D6 none repeat scroll 0 0;
        border: solid #A9A916 1px;
        transition-duration: 0;
      }
      .rangeslider {
        border: solid #333333 1px;
      }
      button.pressed {
        border-style: inset;
      }
      .postit{
        font-size: 0.9em;
      }
      .postit h1 {
        font-size: 2.0em;
      }
      .postit, .postit h1 {
        background-color: #eee;
      }
      .rangewidget input {
        width: 3.1em;
      }
      .rangeslider {
        background: none repeat scroll 0 0 white;
        margin: 0.2em 1em;
      }

      /* custom */
      #wblitz-channels-box {
        width: 25px;
        float:left;
        position: relative;
        top: 50px;
      }
      #wblitz-channels-box button {
        width: 25px;
        float: left;
        position: relative;
        left: -5px;
        text-indent: 1000px; /** hide text **/
      }
      /** hide channel checkboxes from rdef table **/
      input.rd-wblitz-ch {
        display: none;
      }
    </style>


    <script type="text/javascript">

        var PLATE_LINKS_URL_999 = '{% url 'webgateway_object_table_query' 'Screen.plateLinks.child.wells' 999 %}';
        var PLATE_WELLS_URL_999 = '{% url 'webgateway_object_table_query' 'Plate.wells' 999 %}';

        // not needed, but prevents error message
        var rdChanSelHelper = function() {};

        $(document).ready(function() {

            // Fix size according to right panel size... NB: this behaviour is also in right_plugin.preview.js
            var vpWidth = $("#right_panel").width() - 75,
              vpHeight = Math.min(vpWidth, $("#preview_tab").height() - 100);
            vpHeight = Math.max(300, vpHeight);
            $("#viewport").css({'width': vpWidth + 'px', 'height': vpHeight + 'px'});


            if (typeof OME === "undefined") {OME = {}}

            // init viewport
            {% if share_id %}
            OME.preview_viewport = $.WeblitzViewport($("#viewport"), "{% url 'webindex' %}{{ share_id }}", {'mediaroot': '{{ STATIC_URL }}' } );
            {% else %}
            OME.preview_viewport = $.WeblitzViewport($("#viewport"), "{% url 'webindex' %}", {'mediaroot': '{{ STATIC_URL }}' } );
            {% endif %}

            OME.preview_viewport.bind('imageLoad', _refresh_cb);
            OME.preview_viewport.bind('channelChange', channelChange);
            OME.preview_viewport.bind('imageChange', function(){
              syncChannelsActive(OME.preview_viewport);
            });

            // Load image
            {% if share_id %}
            OME.preview_viewport.load({{ manager.image.id }}, null, location.search);
            {% else %}
            OME.preview_viewport.load({{ manager.image.id }});
            {% endif %}

            // copy and paste refs is in browser via query string,
            // but we also save to session in case of page reload etc
            var copy_paste_rdef_url = "{% url 'webgateway.views.copy_image_rdef_json' %}";
            $(".btn.copy_rdef").click(function() {
                var rdefQry = OME.preview_viewport.getQuery();
                setRdefQuery(rdefQry);
                // also need pixelsType to know if we can paste to target
                var pr = OME.preview_viewport.loadedImg.pixel_range.join(":");
                $.getJSON(copy_paste_rdef_url + "?" + rdefQry + "&pixel_range=" + pr);
            });
            $(".btn.paste_rdef").click(function() {
                pasteRdefs(OME.preview_viewport);
            });

            var applysettings = function(){
              applyRDCW(OME.preview_viewport);
            }
            $('#rd-wblitz-rmodel').click(applysettings);

            $("#rdef-setdef-btn").click(function(){
              setImageDefaults(OME.preview_viewport, this, function() {
                OME.refreshThumbnails({{ manager.image.id }});
              });
            });

            // Reset defaults without saving
            $("#rdef-reset-btn").click(function(){
              resetImageDefaults(OME.preview_viewport);
            });

            $("#rdef-minmax-btn").click(function(){
              OME.preview_viewport.setChannelMinMax();
              syncRDCW(OME.preview_viewport);
              OME.preview_viewport.save_channels();
              updateUndoRedo(OME.preview_viewport);
            });

            $("#rdef-fullrange-btn").click(function(){
              OME.preview_viewport.setChannelFullRange();
              syncRDCW(OME.preview_viewport);
              OME.preview_viewport.save_channels();
              updateUndoRedo(OME.preview_viewport);
            });

            // Undo/redo buttons
            $("#rdef-undo-btn").click(function(){
              OME.preview_viewport.undo_channels();
              syncRDCW(OME.preview_viewport);
            });
            $("#rdef-redo-btn").click(function(){
              OME.preview_viewport.redo_channels();
              syncRDCW(OME.preview_viewport);
            });

        });
    </script>


<!-- VIEWER "Preview"-->
<div class="right_tab_inner">
	
<!-- open-image link -->

			<button class="btn silver btn_text" href="#" onclick="return OME.openPopup('{% if share_id %}{% url 'web_image_viewer' share_id manager.image.id %}{% else %}{% url 'web_image_viewer' manager.image.id %}{% endif %}')" alt="View" title="Open full viewer">
				<span>
                {% trans "Launch full viewer" %} 
				</span>
			</button>

    <div style="clear:both"></div>

    <div id="wblitz-channels-box"></div>

    <div id="vp_container" style="position: relative; left: 25px">
      <div class="miniview" id="viewport">
      </div>
    </div>

    <div style="clear:both"></div>

    <hr>

    <ul>
      <li class="buttonbar">
        <button id="rdef-setdef-btn" class="editor"
            {% if not manager.image.canAnnotate or blitzcon.getShareId %}disabled='true'{% endif %}
            title="Applies and saves the current settings as default.">
          save
        </button>
      </li>
    </ul>
    <ul>
      <li>
        <button id="rdef-reset-btn" class="editor"
            {% if not manager.image.canAnnotate or blitzcon.getShareId %}disabled='true'{% endif %}
            title="Returns the image settings to their original state at time of import.">
          reset
        </button>
        <button id="rdef-minmax-btn" title="Each slider will be set to cover the full range of pixel intensities for that channel">
          min/max
        </button>
        <button id="rdef-fullrange-btn" title="Each slider will be set to cover the full range of pixel intensities for that channel">
          full range
        </button>
        |
        <button id="rdef-undo-btn" title="Undo the last changes to settings.">undo</button>
        <button id="rdef-redo-btn" title="Returns to the settings as they were before clicking undo.">redo</button>
      </li>
      {% block batch_copy %}
      {% if dataset.canOwnerWrite %}
      <!--<li class="buttonbar">
          <button id="rdef-batchcopy-btn" class="editor" onclick="return batchCopyRDefs(this);" title="Offers options to apply current settings to other images in your manuscript.">Apply to others</button>
      </li>-->
      {% endif %}
      {% endblock batch_copy %}
    </ul>
    <hr />

    <div id="rdef-postit">
      <div id="rdef-active-area">
        <label for="rd-wblitz-rmodel">Render as Color</label>
        <input id="rd-wblitz-rmodel" type="checkbox" onchange="return rdChanSelHelper(this);" />
        <table cellspacing="0" style="font-size:0.9em">
          <tr>
          </tr>
        </table>
      </div>
    </div>

    <hr>

    Rendering Settings:
    <button class="btn silver btn_text copy_rdef" title="Copy Rendering Settings">
        <span>Copy</span>
    </button>

    <button class="btn silver btn_text paste_rdef" title="Paste Rendering Settings">
        <span>Paste</span>
    </button>

</div>
