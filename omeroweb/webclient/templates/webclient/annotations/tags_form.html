{% load i18n %}
{% load common_filters %}

{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% comment %}
<!--
  This is the content of a form for adding new Tags or choosing existing ones.
  Loaded by AJAX into a form dialog.
-->
{% endcomment %}


<div class="standard_form">

    <h1>{% trans "Select from available tags or Add new tag" %}:</h1>

    <input type="text" id="id_tag" />
    <textarea id="tag_description"></textarea>

    <button id="id_add_new_tag"> <img src="{% static "webclient/image/plus.png" %}" /> Add new </button>

    <div style="float: left;">

        <h1>{% trans "Available Tags" %}:</h1>
        <div class="tag_selection_wrapper">
            <div id="id_all_tags" class="tag_selection"></div>
        </div>

    </div>


    <div id="id_move_tags">

        <button id="id_tag_select_button"> <img src="{% static "webclient/image/icon_arrow_right.png" %}" /> </button>
        <button id="id_tag_deselect_button"> <img src="{% static "webclient/image/icon_arrow_left.png" %}" /> </button>

    </div>

    <div style="float: left;">

        <h1>{% trans "Selected Tags" %}:</h1>
        <div class="tag_selection_wrapper">
            <div id="id_selected_tags" class="tag_selection"></div>
        </div>

    </div>


        <!-- hidden fields used to specify the objects we're tagging -->
        <div class="hiddenField">{{ form_tags.image }}</div>
        <div class="hiddenField">{{ form_tags.dataset }}</div>
        <div class="hiddenField">{{ form_tags.project }}</div>
        <div class="hiddenField">{{ form_tags.screen }}</div>
        <div class="hiddenField">{{ form_tags.plate }}</div>
        <div class="hiddenField">{{ form_tags.acquisition }}</div>
        <div class="hiddenField">{{ form_tags.well }}</div>
        <div class="hiddenField"><input type="text" name="index" value="{{ index }}"/></div>

        <div class="hiddenField">{{ form_tags.tags }}</div>
        <div class="hiddenField">{{ newtags_formset.management_form }}</div>

</div>


<script>
    var div_all_tags = $("#id_all_tags");
    var div_selected_tags = $("#id_selected_tags");
    var tag_input = $("#id_tag");
    var description_input = $("#tag_description");

    var child_tags;
    var all_tags = (function() {
        var raw_tags = {{ all_tags|safe }};
        child_tags = (function() {
            var children = {};
            for (var idx in raw_tags) {
                var c = raw_tags[idx][4];
                if (c) {
                    for (var cidx in c) {
                        children[c[cidx]] = true;
                    }
                }
            }
            return children;
        })();
        var tagstruct = function(tag) {
            if (tag) return {
                i: tag[0],
                d: tag[1],
                t: tag[2],
                o: tag[3],
                s: tag[4]
            };
        };
        var result = {};
        for (var idx in raw_tags) {
            var tag = tagstruct(raw_tags[idx]);
            result[tag.i] = tag;
        }
        return result;
    })();
    var owners = {{ all_tags_owners|safe }};

    var encode_html = function(text) {
        return $('<div/>').text(text).html();
    }

    var create_tag_html = function(text, description, owner, id, parent_id, is_tagset) {
        var title = "";
        if (owner) {
            title += "<b>Owner:</b> " + owner + "<br />";
        }
        if (description) {
            title += "<b>Description:</b> " + description;
        }
        var cls = is_tagset ? "alltags-tagset" : (parent_id ? "alltags-childtag" : "alltags-tag");
        var html = "<div class='" + cls + "' data-id='" + id + "'";
        if (parent_id) {
            html += " data-set='" + parent_id + "'";
        }
        if (id < 0) { // new tag, save description
            html += " data-description='" + encode_html(description) + "'";
        }
        if (title) {
            html += " title='" + encode_html(title) + "'";
        }
        html += ">" + text + "</div>";
        return html;
    };

    var html = "";
    for (var id in all_tags) {
        var tag = all_tags[id];
        if (!(id in child_tags)) {
            html += create_tag_html(tag.t, tag.d, owners[tag.o], tag.i, null, tag.s);
            tag.sort_key = tag.t.toLowerCase();
            if (tag.s) {
                for (var sid in tag.s) {
                    var child = all_tags[tag.s[sid]];
                    child.sort_key = tag.t.toLowerCase() + child.t.toLowerCase();
                    html += create_tag_html(child.t, child.d, owners[child.o], child.i, tag.i);
                }
            }
        }
    }
    div_all_tags.append(html);

    var select_tags = function(event) {
        // clear selections in right box
        $("div.ui-selected", div_selected_tags).removeClass('ui-selected');
        // move individual tags first
        $("div.ui-selected.alltags-tag:not(.filtered), div.ui-selected.alltags-childtag:not(.filtered)", div_all_tags).each(function() {
            $(this).appendTo(div_selected_tags);
        });
        // move whole tag sets
        $("div.ui-selected.alltags-tagset:not(.filtered)", div_all_tags).each(function() {
            var tag = $(this).next("div.alltags-childtag");
            while (tag.length) {
                var current = tag;
                tag = current.next("div.alltags-childtag");
                if (!current.hasClass("filtered")) {
                    current.addClass('ui-selected').appendTo(div_selected_tags);
                }
            }
        });
        sort_tag_list(div_selected_tags);
        update_filter();
        // scroll to first selected tag
        div_selected_tags.parent().scrollTop($("div.ui-selected", div_selected_tags).offset().top - div_selected_tags.offset().top - 40);
        event.preventDefault();
    };

    var deselect_tags = function(event) {
        // clear selections in left box
        $("div.ui-selected", div_all_tags).removeClass('ui-selected');
        // move tags back to left box
        $("div.ui-selected", div_selected_tags).each(function() {
            var tagset = $(this).attr("data-set");
            if (tagset) {
                $(this).insertAfter($("div[data-id=" + tagset + "]", div_all_tags));
            } else {
                $(this).appendTo(div_all_tags);
            }
        });
        sort_tag_list(div_all_tags);
        update_filter();
        // scroll to first selected tag
        div_all_tags.parent().scrollTop($("div.ui-selected", div_all_tags).offset().top - div_all_tags.offset().top - 40);
        event.preventDefault();
    };

    var update_filter = function() {
        var filters = $.trim(tag_input.val()).toLowerCase().split(/ +/);
        if (filters.length == 1 && filters[0] == "") {
            $("div.filtered", div_all_tags).removeClass('filtered');
        } else {
            $("div.alltags-childtag,div.alltags-tag", div_all_tags).each(function() {
                var match = true;
                var text = all_tags[this.getAttribute("data-id")].t.toLowerCase();
                for (filter in filters) {
                    match = match && text.indexOf(filters[filter]) >= 0;
                }
                $(this).toggleClass("filtered", !match);
            });
        }
        // make sure tagsets with unfiltered tags are also not filtered
        var unfiltered_tagsets = {};
        $("div.alltags-childtag:not(.filtered)", div_all_tags).each(function() {
            unfiltered_tagsets[this.getAttribute("data-set")] = true;
        });
        $("div.alltags-tagset", div_all_tags).each(function() {
            $(this).toggleClass('filtered', !unfiltered_tagsets[this.getAttribute("data-id")]);
        });
        // hide tag sets that have no unselected tags anymore
        $("div.alltags-tagset + div.alltags-tagset, div.alltags-tagset:last-child", div_all_tags).prev().addClass('empty-tagset');
        $("div.alltags-tagset + div.alltags-childtag", div_all_tags).prev().removeClass('empty-tagset');
    };

    var new_tag_counter = 0;

    var add_new_tag = function() {
        var text = $.trim(tag_input.val());
        var description = $.trim(description_input.val());
        if (text.length > 0) {
            new_tag_counter -= 1;
            all_tags[new_tag_counter] = {
                i: new_tag_counter,
                d: description,
                t: text,
                o: null,
                s: false
            };
            var div = $(create_tag_html(text, description, null, new_tag_counter));
            div.addClass('ui-selected').tooltip();
            div_selected_tags.append(div);
            tag_input.val('');
            description_input.val('');
        }
        sort_tag_list(div_selected_tags);
        update_filter();
        // scroll to first selected tag
        div_selected_tags.parent().scrollTop($("div.ui-selected", div_selected_tags).offset().top - div_selected_tags.offset().top - 40);
        event.preventDefault();
    };

    var save_tags = function() {
        var existing_tags = [];
        var new_tags = $("#id_{{ newtags_formset.prefix }}-TOTAL_FORMS");
        var count = 0;
        $('div', div_selected_tags).each(function() {
            var tag_id = this.getAttribute('data-id');
            if (tag_id[0] == "-") { // newly created tag
                new_tags.after($("<input type='hidden' />").attr('name', "newtags-" + count + "-tag").val($(this).text()));
                new_tags.after($("<input type='hidden' />").attr('name', "newtags-" + count + "-description").val(this.getAttribute('data-description')));
                count += 1;
            } else { // previously existing tag
                existing_tags.push(tag_id);
            }
        });
        new_tags.val(count);
        $("#{{ form_tags.tags.auto_id }}").val(existing_tags.join(','));
    };

    var sort_tag_list = function(list) {
        $("div", list).sort(function(a, b) {
            return (all_tags[a.getAttribute('data-id')].sort_key >
                    all_tags[b.getAttribute('data-id')].sort_key ? 1 : -1);
        }).appendTo(list);
    };

    var selected_tags = {{ selected_tags }};
    for (var idx in selected_tags) {
        $("div[data-id=" + selected_tags[idx] + "]", div_all_tags).appendTo(div_selected_tags);
    }

    $("#id_tag_select_button").click(select_tags);
    $("#id_tag_deselect_button").click(deselect_tags);
    $("#id_add_new_tag").click(add_new_tag);
    $("#add_tags_form").off('prepare-submit').on('prepare-submit', save_tags);

    sort_tag_list(div_all_tags);
    sort_tag_list(div_selected_tags);

    $(".tag_selection").selectable({ filter: "div:not(.filtered)" });

    update_filter();

    tag_input.keyup(update_filter).change(update_filter);

    $("div", div_all_tags).tooltip();
    $("div", div_selected_tags).tooltip();

</script>
