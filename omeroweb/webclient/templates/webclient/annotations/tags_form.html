{% load i18n %}
{% load common_filters %}

{% comment %}
<!--
  Copyright (C) 2011 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}

{% comment %}
<!--
  This is the content of a form for adding new Tags or choosing existing ones.
  Loaded by AJAX into a form dialog.
-->
{% endcomment %}

<div class="standard_form">

    <h1>{% trans "Select from available tags or Add new tag" %}:</h1>

    {{ form_tags.tag }}
    {{ form_tags.description }}
    <button id="id_add_new_tag"> <img src="{% static "webclient/image/plus.png" %}" /> Add new </button>

    <div style="float: left;">

        <h1>{% trans "Available Tags" %}:</h1>
        <div id="id_all_tags" class="tag_selection"></div>

    </div>


    <div id="id_move_tags">

        <button> <img src="{% static "webclient/image/icon_arrow_right.png" %}" /> </button>
        <button> <img src="{% static "webclient/image/icon_arrow_left.png" %}" /> </button>

    </div>

    <div style="float: left;">

        <h1>{% trans "Selected Tags" %}:</h1>
        <div id="id_selected_tags" class="tag_selection"></div>

    </div>


        <!-- hidden fields used to specify the objects we're tagging -->
        <div class="hiddenField">{{ form_tags.image }}</div>
        <div class="hiddenField">{{ form_tags.dataset }}</div>
        <div class="hiddenField">{{ form_tags.project }}</div>
        <div class="hiddenField">{{ form_tags.screen }}</div>
        <div class="hiddenField">{{ form_tags.plate }}</div>
        <div class="hiddenField">{{ form_tags.acquisition }}</div>
        <div class="hiddenField">{{ form_tags.well }}</div>
        <div class="hiddenField"><input type="text" name="index" value="{{ index }}"/></div>


</div>

<style>
    input#id_tag {
        background: url({% static 'webclient/image/search.png' %}) no-repeat right center;
        width: 200px;
        vertical-align: top;
    }
    textarea#id_description {
        width: 420px;
    }
    button#id_add_new_tag {
        vertical-align: top;
    }
    div#id_move_tags {
        float: left;
        width: 40px;
        padding-top: 100px;
        margin: 10px;
        text-align: center;
    }
    div#id_move_tags button {
        width: 25px;
        height: 25px;
        margin-bottom: 10px;
    }
    div.tag_selection {
        height: 200px;
        width: 320px;
        overflow-y: scroll;
        overflow-x: hidden;
        font-size: larger;
        border: thin solid black;
        padding: 3px;
        background-color: white;
    }
    div.tag_selection div {
        white-space: nowrap;
        padding-left: 22px;
        padding-top: 2px;
        height: 1.5em;
    }
    div.tag_selection div.alltags-tagset {
        background: url({% static "webclient/image/left_sidebar_icon_tags.png" %}) no-repeat left center;
    }
    div.tag_selection div.alltags-tag {
        background: url({% static "webclient/image/left_sidebar_icon_tag.png" %}) no-repeat left center;
    }
    div.tag_selection div.alltags-childtag {
        background: url({% static "webclient/image/left_sidebar_icon_tag.png" %}) no-repeat left center;
        margin-left: 20px;
    }
    div#id_selected_tags div.alltags-childtag {
        margin-left: 0;
        background-color: hsl(215,20%,90%);
    }
    div.tag_selection div.ui-selected {
        background-color: hsl(215,20%,75%) !important;
    }

</style>

<script>
    var div_all_tags = $("#id_all_tags");
    var div_selected_tags = $("#id_selected_tags");
    $(".tag_selection").selectable();

    var all_tags = {{ all_tags|safe }};
    var html = "";
    for (var id in all_tags) {
        var tag = all_tags[id];
        if (!tag.c) {
            var cls = tag.s ? 'alltags-tagset' : 'alltags-tag';
            html += "<div class='" + cls + "' data-id='" + tag.i + "'>" + tag.t + "</div>";
            if (tag.s) {
                for (var sid in tag.s) {
                    var child = all_tags[tag.s[sid]];
                    html += "<div class='alltags-childtag' data-id='" + child.i + "'>" + child.t + "</div>";
                }
            }
        }
    }

    div_all_tags.append(html);

    var selected_tags = {{ selected_tags }};

/*
    selected_tags.push(7);
    selected_tags.push(9);
    selected_tags.push(8444);
    selected_tags.push(8446);
*/

    for (var idx in selected_tags) {
        $("div[data-id=" + selected_tags[idx] + "]", div_all_tags).appendTo(div_selected_tags);
    }

    var hide_empty_tagsets = function() {
        // hide tag sets that have no unselected tags anymore
        $("div.alltags-tagset + div.alltags-tagset", div_all_tags).prev().hide();
        $("div.alltags-tagset:last-child").hide();
    }

    hide_empty_tagsets();

</script>
