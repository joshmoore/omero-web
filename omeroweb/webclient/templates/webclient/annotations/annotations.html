{% extends "webclient/base/base_frame.html" %}
{% load i18n %}
{% load markup %}
{% load custom_tags %}

{% block link %}
    <link rel="stylesheet" href="{% url webstatic "css/images.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/googiespell.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/annotation.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/autocomplete.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" href="{% url webstatic "css/tooltip.css" %}" type="text/css" media="screen"/>
    <link rel="stylesheet" type="text/css" href="/appmedia/webgateway/css/panojs.css" media="all" />

    <link rel="stylesheet" href="/appmedia/webgateway/css/jquery-plugin-gs_slider.css" type="text/css" media="screen"/>
    <link rel="stylesheet" href="/appmedia/webgateway/css/weblitz-viewport.css" type="text/css" media="screen"/>
{% endblock %}

{% block jscript %}

    <script type="text/javascript" src="{% url webstatic "javascript/jquery.autocomplete.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/jquery.quicksearch.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/jquery.tooltip.js" %}"></script>
  
    <script type="text/javascript" src="{% url webstatic "javascript/ui/ui.core.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/ui/ui.tabs.js" %}"></script>
    
    <script type="text/javascript" src="{% url webstatic "javascript/googiespell/AJS.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/googiespell/googiespell.js" %}"></script>
    <script type="text/javascript" src="{% url webstatic "javascript/googiespell/cookiesupport.js" %}"></script>
    
    {% if manager.image or manager.well %}
    <script type="text/javascript" src="/appmedia/webgateway/js/weblitz-viewport.js"></script>
    <script type="text/javascript" src="/appmedia/webgateway/js/jquery-plugin-viewportImage.js"></script>
    <script type="text/javascript" src="/appmedia/webgateway/js/jquery-plugin-gs_slider.js"></script>
    <script type="text/javascript" src="/appmedia/webgateway/js/gs_utils.js"></script>
    <script type="text/javascript" src="/appmedia/webgateway/js/panojs/PanoJS.js"></script>
    {% endif %}
    
{% endblock %}

{% block script %}

    <script type="text/javascript" src="{% url webstatic "javascript/actions.js" %}"></script>
    
    <script type="text/javascript">
        $(document).ready(function() 
            {
                // hide any unset fields. 
                var invalidRows = $(".metadata_details input:not([value])").parent().parent();
                invalidRows.hide();
                var naRows = $(".metadata_details input[value='N/A']").parent().parent();
                naRows.hide();
                var invalidSelects = $(".metadata_details select option[selected][value='']").parent().parent().parent();
                invalidSelects.hide();
                // set up toggling... add click button
                var show_text = "Show unset fields";
                var hide_text = "Hide unset fields";
                var show_hide_html = "<a href='#' class='show_hide_invalid'>"+ show_text +"</a>";
                $(".metadata_details").append($(show_hide_html));
                var toggleInvalidRows = function(event) {
                    var $target = $(event.target);
                    if ($target.attr('class') == "show_hide_invalid") {
                        // toggle text
                        if ($target.text() == show_text) $target.text(hide_text);
                        else $target.text(show_text);
                        // toggle fields
                        var invalidRows = $(this).find("input:not([value])").parent().parent();
                        invalidRows.toggle();
                        var naRows = $(this).find("input[value='N/A']").parent().parent();
                        naRows.toggle();
                        var invalidSelects = $(this).find("select option[selected][value='']").parent().parent().parent();
                        invalidSelects.toggle();
                    };
                };
                $(".metadata_details").click(toggleInvalidRows);
                
                
                $('input#search_global').quicksearch('table#global_metadata tbody tr', {
                	'delay': 300,
                    'loader': 'span.loading_global'
                });
                $('input#search_series').quicksearch('table#series_metadata tbody tr', {
                	'delay': 300,
                    'loader': 'span.loading_series'
                });
                
                $("#annotation_tabs").tabs();   
                
                var loaded = false;
                $('a[href="#preview_tab"]').click(function() {
                    if (!loaded) {
                        var viewport = $.WeblitzViewport($("#viewport"), "/webclient" );
                        {% if manager.image %} viewport.load({{ manager.image.id }}); {% endif %}
                        {% if manager.well %} viewport.load({{ manager.well.selectedWellSample.image.id }}); {% endif %}
                        loaded = true;
                    }
                });       
                
                $("{% for t in manager.tag_annotations %}#tagdesc{{ t.id }}, {% endfor %}#tag").tooltip({ 
                    track: true, 
                    delay: 0, 
                    showURL: false, 
                    opacity: 1, 
                    fixPNG: true, 
                    showBody: " - ", 
                    top: -15, 
                    left: 5 
                }); 
                
                $("#custom_annotations td span").hide() // hide the tool tip source elements
                $("#custom_annotations td").tooltip({ 
                    bodyHandler: function() { 
                            return $(this).children("span").html(); 
                        },
                    track: true, 
                    delay: 0, 
                    showURL: false, 
                    fixPNG: true, 
                    showBody: " - ", 
                    top: 10, 
                    left: -100 
                });       
                
                $(".show_xml").next().hide();   // hide any XML annotation blocks
                // display in a new window      
                $(".show_xml").click(function() {
                    var xml = $(this).next().html();
                    var newWindow=window.open('','name','height=500,width=500,scrollbars=yes, top=50, left=100');
                    newWindow.document.write(xml);
                    newWindow.document.close();
                    return false;
                });
                
                $('.can-collapse').click(function () {
                  $(this).toggleClass('closed').next().slideToggle();
                });

                $('.can-collapse.defclose').each(function () {
                  $(this).removeClass('defclose').toggleClass('closed').next().hide();
                });

            });


            function deleteItem(productType, productId) {
                if ((productType == 'file' || productType == 'tag' || productType == 'comment') && productId > 0){
                    if (confirm('Delete '+productType+'?')) {
                        var productListQuery="";
                        $.ajax({
                            type: "POST",
                            url: "/webclient/action/delete/"+productType+"/"+productId+"/", //this.href,
                            data: productListQuery,
                            contentType:'html',
                            success: function(responce){
                                if(responce.match(/(Error: ([A-z]+))/gi)) {
                                    alert(responce)
                                } else {  
                                    window.location = "{{ url }}";
                                }
                            },
                            error: function(responce) {
                                alert("Internal server error. Cannot delete object.");
                            }
                        });

                    }
                } 
            }
    </script>
    
{% endblock %}

{% block content %}
<div id="annotation_form" >
    <div id="annotation_tabs" class="ui-tabs">
        <ul>
            {% if manager.tag %}
                <li><a href="#metadata_tab">{% trans "General" %}</a></li>
            {% else %}
                <li><a href="#annotation_tab">{% trans "General" %}</a></li>
                {% if manager.image or manager.well %}
                    <li><a href="#metadata_tab">{% trans "Acquisition" %}</a></li>                
                    <li><a href="#preview_tab">{% trans "Preview" %}</a></li>
                {% endif %}
            {% endif %}
        </ul>
        <div class="clear"></div>        
        
        {% if manager.image %}
        <!-- VIEWER "Preview"-->
        <div id="preview_tab">
            <div class="miniview" id="viewport"></div>
        </div>
        {% endif %}
        {% if manager.well %}
        <!-- VIEWER "Preview" -->
        <div id="preview_tab">
            <div class="miniview" id="viewport"></div>
        </div>
        {% endif %}
        
        
        <!-- METADATA "Acquisition" TAB -->
        <div id="metadata_tab">
            
            {% if manager.well or manager.image%}
            
            {% if manager.companion_files %}
            <h1 class="can-collapse defclose">{% trans "Companion Files" %}</h1>                
            <div>
                {% for fileann in manager.companion_files %}
                <p>
                    <a href="#" onClick="document.location.href='{% url download_annotation "download" fileann.id %}';">
                        {{ fileann.getFileName|shortening:40 }}
                    </a>
                    ({{ fileann.getFileSize|default_if_none:0|filesizeformat }})
                </p>
                {% endfor %}
            </div>
            {% endif %}
            
            {% if manager.global_metadata or manager.series_metadata %}
            <h1 class="can-collapse defclose">{% trans "Original Metadata" %} <input type="button" value="Download" onClick="document.location.href='{% url download_annotation "download" manager.original_metadata.id %}';"/></h1>                
                <div>
                    {% if manager.global_metadata %}
                    <h1>Global Metadata</h1>
                    <div style="height:250px; overflow:auto">
                        <form class="quicksearch" id="quicksearch_global" action="#"><label for="id_search">Filter:</label> <input type="text" id="search_global" value="search"> <span class="loading_global"><img class="loader" alt="Loading" src="{% url webstatic "images/spinner.gif" %}"></span></form>
                        <table id="global_metadata" class="metadata_details"><tbody>
                            {% for gm in manager.global_metadata %}
                            <tr><td><label>{{ gm.0 }}</label></td><td>{{ gm.1 }}</td></tr>
                            {% endfor %}
                        <tr><th colspan="2"><br/></th></tr>
                        </tbody></table>
                    </div>
                    {% endif %}
            
                    {% if manager.series_metadata %}
                    <hr />
                    <h1>Series Metadata</h1>
                    <div style="height:250px; overflow:auto">
                        <form class="quicksearch" id="quicksearch_series" action="#"><label for="id_search">Filter:</label> <input type="text" id="search_series" value="search"> <span class="loading_series"><img class="loader" alt="Loading" src="{% url webstatic "images/spinner.gif" %}"></span></form>
                        <table id="series_metadata" class="metadata_details"><tbody>
                            {% for sm in manager.series_metadata %}
                            <tr><td><label>{{ sm.0 }}</label></td><td>{{ sm.1 }}</td></tr>
                            {% endfor %}
                            <tr><th colspan="2"><br/></th></tr>
                        </tbody></table>
                    </div>
                    {% endif %}
                </div>
            {% endif %}
                        
            <!-- Microscope -->
            {% if form_objective or form_filters or form_detectors %}
            <h1 class="can-collapse defclose">{% trans "Microscope" %}</h1>
            <div>
                {% if form_microscope %}
                <table class="metadata_details">
                    {% for field in form_microscope %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
                {% if form_objective %}
                <table class="metadata_details">
                <tr><th><br/>{% trans "Objective" %}:</th><th colspan="2"></th></tr>
                    {% for field in form_objective %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
                {% for form in form_filters %}
                <table class="metadata_details">
                    <tr><th><br/>{% trans "Filter" %}:</th><th colspan="2"></th></tr>
                    {% for field in form %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endfor %}
                {% for form in form_detectors %}
                <table class="metadata_details">
                    <tr><th><br/>{% trans "Detector" %}:</th><th colspan="2"></th></tr>
                    {% for field in form %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endfor %}
                {% for form in form_lasers %}
                <table class="metadata_details">
                    <tr><th><br/>{% trans "Laser" %}:</th><th colspan="2"></th></tr>
                    {% for field in form %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Image -->
            {% if form_objective or form_environment or form_stageLabel %}
            <h1 class="can-collapse defclose">{% trans "Image" %}</h1>
            <div><table class="metadata_details">
                {% if form_objective %}
                <tr><th><br/>{% trans "Objective" %}:</th><th colspan="2"></th></tr>
                    {% for field in form_objective %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
                {% if form_environment %}
                <tr><th><br/>{% trans "Environment" %}:</th><th colspan="2"></th></tr>
                    {% for field in form_environment %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
                {% if form_stageLabel %}
                <tr><th><br/>{% trans "Stage label" %}:</th><th colspan="2"></th></tr>
                    {% for field in form_stageLabel %}
                    <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                        <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </table></div>
            {% endif %}
            
            <!-- Channels -->
            {% for ch in form_channels %}
            <h1 class="can-collapse defclose"><span style="padding:0 3px; color:#000; border:1px solid #000; background-color: #{{ ch.color }};">&nbsp&nbsp</span> {{ ch.name }}</h1>
            <div id="channel_{{ forloop.counter }}">
            <table class="metadata_details">
                {% for field in ch.form %}
                <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                    <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                </tr>
                {% endfor %}
                {% if ch.form_emission_filter or ch.form_excitation_filter %}
                {% for f in ch.form_emission_filter %}
                <tr><th><br/>{% trans "Filter" %}:</th><th colspan="2"></th></tr>
                {% for field in f %}
                <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                    <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                </tr>
                {% endfor %}
                {% endfor %}
                {% for f in ch.form_excitation_filter %}
                {% for field in f %}
                <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                    <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                </tr>
                {% endfor %}
                {% endfor %}
                {% endif %}
            </table>
            <table class="metadata_details">
                {% if ch.form_detector_settings %}
                <tr><th><br/>{% trans "Detector" %}:</th><th colspan="2"></th></tr>
                {% for field in ch.form_detector_settings %}
                <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                    <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                </tr>
                {% endfor %}
                {% endif %}                
                {% if ch.form_dichroic %}
                <tr><th><br/>{% trans "Dichroic" %}:</th><th colspan="2"></th></tr>
                {% for field in ch.form_dichroic %}
                <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                    <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                </tr>
                {% endfor %}
                {% endif %}
                {% if ch.form_light_source %}
                <tr><th><br/>{% trans "Laser" %}:</th><th colspan="2"></th></tr>
                {% for field in ch.form_light_source %}
                <tr><td>{{ field.label_tag }}{% if field.field.required %}*{% endif %}</td>
                    <td>{{ field }}</td><td>{% if field.errors %}{{ field.errors }}{% endif %}<br/>{{ field.help_text|safe }}</td>
                </tr>
                {% endfor %}
                {% endif %}
            </table>
            </div>
            {% endfor %}
                        
            <br/><p>*{% trans "N/A - this value is not available." %}</p>
            {% endif %}
            <div class="clear"></div>
        </div>        
                
        {% if not manager.tag %}
        <!-- ANNOTATIONS "General" -->
        <div id="annotation_tab">
            {% if manager.image %}
            <h1>
                {{ manager.image.name|warphtml:"30" }}
                {% if manager.image.isOwned %} <a href="{% url manage_action_containers "edit" "image" manager.image.id %}?url={{url}}"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit"/></a>{% endif %}
            </h1>            
            <h2 id='image_id'>Image ID: {{ manager.image.id }}</h2>    
            <!-- open-image link -->
            <p>{% trans "Launch full viewer" %} <a href="#" onclick="return openPopup('{% url web_image_viewer manager.image.id %}')"><img id="{{ manager.image.id }}" src="{% url webstatic "images/kview16.png" %}" alt="View" title="Open full viewer"/></a></p>
                    
            <div class="description">
                {% if manager.image.isOwned %} <a href="{% url manage_action_containers "edit" "image" manager.image.id %}?url={{url}}" class="align_left"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit" /></a>{% endif %}
                {{ manager.image.description|default_if_none:"Description:"|linebreaks }}
            </div>            
            <table>                    
                {% if not manager.image.isOwned %}
                <tr>
                    <th>Owner:</th>
                    <td id='owner_fullname'>{{ manager.image.getOwner.getFullName }}</td>                    
                </tr>
                {% endif %}
                <tr>
                    <th>Acquisition Date:</th>
                    <td id='acqu_date'>{{ manager.image.getDate|date:"Y-m-d H:i:s" }}</td> <!-- TODO: Insight is m/d/yy h:min AM/PM -->
                </tr>
                <tr>
                    <th>Imported Date:</th>
                    <td id='import_date'>{{ manager.image.creationEventDate|date:"Y-m-d H:i:s" }}</td>
                </tr>
                <tr>
                    <th>Dimensions (XY):</th>
                    <td id='dims_xy'>{{ manager.image.getWidth }} x {{ manager.image.getHeight }}</td>
                </tr>
                <tr>
                    <th>Pixels Type:</th>
                    <td id='pixels_size'>{{ manager.image.getPixelsType }}</td>
                </tr>
                <tr>
                    <th>Pixels Size (XYZ) (&#181m):</th>
                    <td id='pixels_size'>{{ manager.image.getPixelSizeX|floatformat:4 }} x {{ manager.image.getPixelSizeY|floatformat:4 }} x {{ manager.image.getPixelSizeZ|floatformat:4 }}</td>
                </tr>
                <tr>
                    <th>Z-sections/Timepoints:</th>
                    <td id='dims_zt'>{{ manager.image.z_count }} x {{ manager.image.t_count }}</td>
                </tr>
                <tr>
                    <th>Channels:</th>
                    <td id='channel_names'>
                    {% if manager.image.getChannels %}{% for c in manager.image.getChannels %}{% if not forloop.first %}, {% endif %}{{ c.getName }}{% endfor %}{% else %}<span class="error">No channel specified</span>{% endif %}
                    </td>
                </tr>
            </table>
            {% else %}
                {% if manager.dataset %}
                <h1>
                    {{ manager.dataset.name|warphtml:"30" }}
                    {% if manager.dataset.isOwned %} <a href="{% url manage_action_containers "edit" "dataset" manager.dataset.id %}?url={{url}}"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit"/></a>{% endif %}
                </h1>                
                <h2 id='dataset_id'>Dataset ID: {{ manager.dataset.id }}</h2>
                <div class="description">
                    {% if manager.dataset.isOwned %} <a href="{% url manage_action_containers "edit" "dataset" manager.dataset.id %}?url={{url}}" class="align_left"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit" /></a>{% endif %}
                    {{ manager.dataset.description|default_if_none:"Description:"|linebreaks }}
                </div>
                <table>
                    {% if not manager.dataset.isOwned %}
                    <tr>
                        <th>Owner:</th>
                        <td id='owner_fullname'>{{ manager.dataset.getOwner.getFullName }}</td>                    
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Creation Date:</th>
                        <td id='creation_date'>{{ manager.dataset.getDate|date:"Y-m-d H:i:s" }}</td>
                    </tr>                    
                    <tr>
                        <th>Image Count:</th>
                        <td id='child_count'>{{ manager.dataset.countChildren }} {% plural manager.dataset.countChildren 'image' 'images' %}</td>
                    </tr>
                </table>
                {% else %}
                    {% if manager.project %}
                    <h1>
                        {{ manager.project.name|warphtml:"30" }}
                        {% if manager.project.isOwned %} <a href="{% url manage_action_containers "edit" "project" manager.project.id %}?url={{url}}"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit"/></a>{% endif %}
                    </h1>
                    <h2 id='project_id'>Project ID: {{ manager.project.id }}</h2>
                    <div class="description">
                        {% if manager.project.isOwned %} <a href="{% url manage_action_containers "edit" "project" manager.project.id %}?url={{url}}" class="align_left"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit" /></a>{% endif %}
                        {{ manager.project.description|default_if_none:"Description:"|linebreaks }}
                    </div>
                    <table>
                        {% if not manager.project.isOwned %}
                        <tr>
                            <th>Owner:</th>
                            <td id='owner_fullname'>{{ manager.project.getOwner.getFullName }}</td>                    
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Creation Date:</th>
                            <td id='creation_date'>{{ manager.project.getDate|date:"Y-m-d H:i:s" }}</td>
                        </tr>
                        <tr>
                            <th>Dataset Count:</th>
                            <td id='child_count'>{{ manager.project.countChildren }} {% plural manager.project.countChildren 'dataset' 'datasets' %}</td>
                        </tr>
                    </table>
                    {% endif %}
                {% endif %}
            {% endif %}
            
            {% if manager.well %}            
            <h1>
                {{ manager.well.selectedWellSample.image.name|warphtml:"30" }}
                {% if manager.well.selectedWellSample.image.isOwned %} <a href="{% url manage_action_containers "edit" "image" manager.well.selectedWellSample.image.id %}?url={{url}}"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit"/></a>{% endif %}
            </h1>            
            <h2 id='well_id'>Well ID: {{ manager.well.selectedWellSample.image.id }}</h2>
            <p>{% trans "Launch full viewer" %} <a href="#" onclick="return openPopup('{% url web_image_viewer manager.well.selectedWellSample.image.id %}')"><img id="{{ manager.image.id }}" src="{% url webstatic "images/kview16.png" %}" alt="View" title="Open full viewer"/></a></p>
            <div class="description">
                {% if manager.well.selectedWellSample.image.isOwned %} <a href="{% url manage_action_containers "edit" "image" manager.well.selectedWellSample.image.id %}?url={{url}}" class="align_left"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit" /></a>{% endif %}
                {{ manager.well.selectedWellSample.image.description|default_if_none:"Description:"|linebreaks }}
            </div>            
            <table>                    
                {% if not manager.well.selectedWellSample.image.isOwned %}
                <tr>
                    <th>Owner:</th>
                    <td id='owner_fullname'>{{ manager.well.selectedWellSample.image.getOwner.getFullName }}</td>                    
                </tr>
                {% endif %}
                <tr>
                    <th>Acquisition Date:</th>
                    <td id='acqu_date'>{{ manager.well.selectedWellSample.image.getDate|date:"Y-m-d H:i:s" }}</td> <!-- TODO: Insight is m/d/yy h:min AM/PM -->
                </tr>
                <tr>
                    <th>Imported Date:</th>
                    <td id='import_date'>{{ manager.well.selectedWellSample.image.creationEventDate|date:"Y-m-d H:i:s" }}</td>
                </tr>
                <tr>
                    <th>Dimensions (XY):</th>
                    <td id='dims_xy'>{{ manager.well.selectedWellSample.image.getWidth }} x {{ manager.well.selectedWellSample.image.getHeight }}</td>
                </tr>
                <tr>
                    <th>Pixels Type:</th>
                    <td id='pixels_size'>{{ manager.well.selectedWellSample.image.getPixelsType }}</td>
                </tr>
                <tr>
                    <th>Pixels Size (XYZ) (&#181m):</th>
                    <td id='pixels_size'>{{ manager.well.selectedWellSample.image.getPixelSizeX|floatformat:4 }} x {{ manager.well.selectedWellSample.image.getPixelSizeY|floatformat:4 }} x {{ manager.well.selectedWellSample.image.getPixelSizeZ|floatformat:4 }}</td>
                </tr>
                <tr>
                    <th>Z-sections/Timepoints:</th>
                    <td id='dims_zt'>{{ manager.well.selectedWellSample.image.z_count }} x {{ manager.well.selectedWellSample.image.t_count }}</td>
                </tr>
                <tr>
                    <th>Channels:</th>
                    <td id='channel_names'>
                    {% if manager.well.selectedWellSample.image.getChannels %}{% for c in manager.well.selectedWellSample.image.getChannels %}{% if not forloop.first %}, {% endif %}{{ c.getLogicalChannel.getName }}{% endfor %}{% else %}<span class="error">No channel specified</span>{% endif %}
                    </td>
                </tr>
            </table>
            {% else %}
                {% if manager.plate %}
                <h1>
                    {{ manager.plate.name|warphtml:"30" }}
                    {% if manager.plate.isOwned %} <a href="{% url manage_action_containers "edit" "plate" manager.plate.id %}?url={{url}}"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit"/></a>{% endif %}
                </h1>                
                <h2 id='plate_id'>Plate ID: {{ manager.plate.id }}</h2>
                <div class="description">
                    {% if manager.plate.isOwned %} <a href="{% url manage_action_containers "edit" "plate" manager.plate.id %}?url={{url}}" class="align_left"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit" /></a>{% endif %}
                    {{ manager.plate.description|default_if_none:"Description:"|linebreaks }}
                </div>
                <table>
                    {% if not manager.plate.isOwned %}
                    <tr>
                        <th>Owner:</th>
                        <td id='owner_fullname'>{{ manager.plate.getOwner.getFullName }}</td>                    
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Creation Date:</th>
                        <td id='creation_date'>{{ manager.plate.getDate|date:"Y-m-d H:i:s" }}</td>
                    </tr>
                    <!--{% comment %}
                    <tr>
                        <th>Well Count:</th>
                        <td id='child_count'>{{ manager.plate.countChildren }} {% plural manager.plate.countChildren 'well' 'Wells' %}</td>
                    </tr>
                    {% endcomment %}-->
                </table>
                {% else %}
                    {% if manager.screen %}
                    <h1>
                        {{ manager.screen.name|warphtml:"30" }}
                        {% if manager.screen.isOwned %} <a href="{% url manage_action_containers "edit" "screen" manager.screen.id %}?url={{url}}"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit"/></a>{% endif %}
                    </h1>                
                    <h2 id='screen_id'>Screen ID: {{ manager.screen.id }}</h2>
                    <div class="description">
                        {% if manager.screen.isOwned %} <a href="{% url manage_action_containers "edit" "screen" manager.screen.id %}?url={{url}}" class="align_left"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit" /></a>{% endif %}
                        {{ manager.screen.description|default_if_none:"Description:"|linebreaks }}
                    </div>
                    <table>
                        {% if not manager.screen.isOwned %}
                        <tr>
                            <th>Owner:</th>
                            <td id='owner_fullname'>{{ manager.screen.getOwner.getFullName }}</td>                    
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Creation Date:</th>
                            <td id='creation_date'>{{ manager.screen.getDate|date:"Y-m-d H:i:s" }}</td>
                        </tr>                    
                        <tr>
                            <th>Screen Count:</th>
                            <td id='child_count'>{{ manager.screen.countChildren }} {% plural manager.screen.countChildren 'screen' 'screens' %}</td>
                        </tr>
                    </table>
                    {% endif %}
                {% endif %}
            {% endif %}
            
            {% if manager.tag %}
            <h1>
                {{ manager.tag.name|warphtml:"30" }}
                {% if manager.tag.isOwned %} <a href="{% url manage_action_containers "edit" "tag" manager.tag.id %}?url={{url}}"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit"/></a>{% endif %}
            </h1>                
            <h2 id='tag_id'>Tag ID: {{ manager.tag.id }}</h2>
            <div class="description">
                {% if manager.tag.isOwned %} <a href="{% url manage_action_containers "edit" "tag" manager.tag.id %}?url={{url}}" class="align_left"><img src="{% url webstatic "images/color_line12.png" %}" alt="e" title="edit" /></a>{% endif %}
                {{ manager.tag.description|default_if_none:"Description:"|linebreaks }}
            </div>
            <table>
                {% if not manager.tag.isOwned %}
                <tr>
                    <th>Owner:</th>
                    <td id='owner_fullname'>{{ manager.tag.getOwner.getFullName }}</td>                    
                </tr>
                {% endif %}
                <tr>
                    <th>Creation Date:</th>
                    <td id='creation_date'>{{ manager.tag.getDate|date:"Y-m-d H:i:s" }}</td>
                </tr>                    
                <tr>
                    <th>Image Count:</th>
                    <td id='child_count'>{{ manager.tag.countChildren }} {% plural manager.tag.countChildren 'tag' 'tags' %}</td>
                </tr>
            </table>
            {% endif %}
        
        
        <!-- ANNOTATIONS -->
        <h1>{% trans "Annotations" %}:</h1>
        <table>
            <!-- RATING -->
            <tr>
                <th colspan="2">{% trans "Rate" %}:</th>
                <td>
                    {% if manager.rating_annotations %}
                    <div class="lntags">
                        <table>
                    {% for rating in manager.rating_annotations %}
                    <tr><td valign="middle">
                        {% ifequal rating.getValue 0 %}<img src="{% url webstatic "images/rating0.png" %}">{% endifequal %}
                        {% ifequal rating.getValue 1 %}<img src="{% url webstatic "images/rating1.png" %}">{% endifequal %}
                        {% ifequal rating.getValue 2 %}<img src="{% url webstatic "images/rating2.png" %}">{% endifequal %}
                        {% ifequal rating.getValue 3 %}<img src="{% url webstatic "images/rating3.png" %}">{% endifequal %}
                        {% ifequal rating.getValue 4 %}<img src="{% url webstatic "images/rating4.png" %}">{% endifequal %}
                        {% ifequal rating.getValue 5 %}<img src="{% url webstatic "images/rating5.png" %}">{% endifequal %}
                        </td>
                        <td>
                        {{ rating.getDetails.getOwner.getNameWithInitial }}
                        </td>
                    </tr>
                    {% endfor %}
                        </table>
                    </div>
                    {% else %}
                        {% trans "No ratings" %}
                    {% endif %}
                </td>
            </tr> 
            <!-- TAGS -->               
            <tr>
                <th>{% trans "Tag" %}:</th>
                <td>
                    {% if manager.project.isEditable %}<a href="{% url manage_action_containers "newtag" "project" manager.project.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" alt="e" title="Create new tag or use an existing one."/></a>{% else %}
                    {% if manager.dataset.isEditable %}<a href="{% url manage_action_containers "newtag" "dataset" manager.dataset.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" alt="e" title="Create new tag or use an existing one."/></a>{% else %}
                    {% if manager.image.isEditable %}<a href="{% url manage_action_containers "newtag" "image" manager.image.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" height='11' width='11' alt="e" title="Create new tag or use an existing one."/></a>{% else %}
                    {% if manager.screen.isEditable %}<a href="{% url manage_action_containers "newtag" "screen" manager.screen.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" alt="e" title="Create new tag or use an existing one."/></a>{% else %}
                    {% if manager.plate.isEditable %}<a href="{% url manage_action_containers "newtag" "plate" manager.plate.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" alt="e" title="Create new tag or use an existing one."/></a>{% else %}
                    {% if manager.well.isEditable %}<a href="{% url manage_action_containers "newtag" "well" manager.well.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" alt="e" title="Create new tag or use an existing one."/></a>
                    {% endif %}{% endif %}{% endif %}{% endif %}{% endif %}{% endif %}
                </td>
                <td>
                    {% if manager.tgannSize %}
                    <div class="lntags">
                    {% for tag in manager.tag_annotations %}
                        <a href="{% url load_template "usertags" %}{% if not tag.isOwned %}?experimenter={{ tag.getOwner.id }}{% endif %}" target="_top" title="Owned by {{ tag.getDetails.getOwner.getNameWithInitial }}; Linked by {{ tag.link.getDetails.getOwner.getNameWithInitial }}. {{ tag.description|default_if_none:""  }}"> {{ tag.textValue }}</a> {% if tag.link.isOwned %}<a href="{% url manage_action_containers "remove" %}tag/{{ tag.id }}/?parent={% if manager.image %}image-{{ manager.image.id}}{% else %}{% if manager.dataset %}dataset-{{ manager.dataset.id}}{% else %}{% if manager.project %}project-{{ manager.project.id}}{% else %}{% if manager.screen %}screen-{{ manager.screen.id}}{% else %}{% if manager.plate %}plate-{{ manager.plate.id}}{% endif %}{% endif %}{% endif %}{% endif %}{% endif %}&url={{ url }}" onClick="return confirm('Unlink tag?');"><img src="{% url webstatic "images/minus_11.png" %}" alt="u" title="unlink"/></a>{% endif %}, 
                    {% endfor %}
                    </div>
                    {% else %}
                        {% trans "No tags" %}
                    {% endif %}
                </td>
            </tr>
            <!-- FILES -->
            <tr>
                <th>{% trans "Attach" %}:</th>
                <td>
                    {% if manager.project.isEditable %}<a href="{% url manage_action_containers "newfile" "project" manager.project.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" alt="e" title="Attache new file or use an existing one."/></a>{% else %}
                    {% if manager.dataset.isEditable %}<a href="{% url manage_action_containers "newfile" "dataset" manager.dataset.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" alt="e" title="Attache new file or use an existing one."/></a>{% else %}
                    {% if manager.image.isEditable %}<a href="{% url manage_action_containers "newfile" "image" manager.image.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" alt="e" title="Attache new file or use an existing one."/></a>{% else %}
                    {% if manager.screen.isEditable %}<a href="{% url manage_action_containers "newfile" "screen" manager.screen.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" alt="e" title="Attache new file or use an existing one."/></a>{% else %}
                    {% if manager.plate.isEditable %}<a href="{% url manage_action_containers "newfile" "plate" manager.plate.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" alt="e" title="Attache new file or use an existing one."/></a>{% else %}
                    {% if manager.well.isEditable %}<a href="{% url manage_action_containers "newfile" "well" manager.well.id %}?url={{url}}"><img src="{% url webstatic "images/plus_11.png" %}" alt="e" title="Attache new file or use an existing one."/></a>
                    {% endif %}{% endif %}{% endif %}{% endif %}{% endif %}{% endif %}
                </td>
                <td>
                    {% if manager.fileannSize %}
                    <div class="lnfiles">
                        {% for fileann in manager.file_annotations %}
                        <p>
                            <a href="#" onClick="document.location.href='{% url download_annotation "download" fileann.id %}';" 
                                title="Linked by {{ fileann.link.getDetails.getOwner.getNameWithInitial }} {% trans "at" %} {{ fileann.creationEventDate|date:"Y-m-d H:i:s" }}. {% trans "Owner:" %} {{ fileann.getDetails.getOwner.getNameWithInitial }}">
                                {{ fileann.getFileName|shortening:40 }}
                            </a>
                            ({{ fileann.getFileSize|default_if_none:0|filesizeformat }})
                            {% if fileann.link.isOwned and not fileann.isOriginalMetadata %}
                                <a href="{% url manage_action_containers "remove" %}file/{{ fileann.id }}/?parent={% if manager.image %}image-{{ manager.image.id}}{% else %}{% if manager.dataset %}dataset-{{ manager.dataset.id}}{% else %}{% if manager.project %}project-{{ manager.project.id}}{% endif %}{% endif %}{% endif %}&url={{ url }}" onClick="return confirm('Unlink file?');"><img src="{% url webstatic "images/minus_11.png" %}" alt="u" title="unlink"/></a>
                            {% endif %}
                            {% if fileann.canDelete and not fileann.isOriginalMetadata %}
                                <input class="button" type="image" src="{% url webstatic "images/cancel12.png" %}" alt="Delete" title="Delete" onclick="deleteItem('file', '{{ fileann.id }}');" />
                            {% endif %}
                            <!-- if we have 'volume' data attached - link for viewing in Open-Astex Viewer -->
                            {% ifequal fileann.getFileName|slice:"-3:" 'map' %}
                                <a href="#" onclick="return openPopup('{% url open_astex_viewer fileann.id %}')">Volume viewer</a>
                            {% endifequal %}
                            {% ifequal fileann.getFileName|slice:"-3:" 'bit' %}
                                <a href="#" onclick="return openPopup('{% url open_astex_viewer fileann.id %}')">Volume viewer</a>
                            {% endifequal %}
                        </p>
                        {% endfor %}
                    </div>
                    {% else %}
                        {% trans "No attachments." %}
                    {% endif %}
                </td>
            </tr>  
            <!-- CUSTOM ANNOTATIONS -->
            <tr>
                <th>{% trans "Others" %}:</th>
                <td>
                    <!-- no editing of custom annotations-->
                </td>
                <td>
                    <!-- tool tips for each <td> is contained in child <span>, which are also hidden -->
                    <table id="custom_annotations">
                        {% for ann in manager.xml_annotations %}
                        <tr><th>XML:</th>
                            <td>
                                <div>{{ ann.getValue|escape|slice:"0:30" }}...</div>
                                <div class="show_xml">Open in window</div><div>{{ ann.getValue }}</div>
                                <span>{% if ann.ns %}<b>Namespace:</b> {{ ann.ns }}<br />{% endif %}
                                    {% if ann.description %}<b>Description:</b> {{ ann.description }}<br />{% endif %}
                                    <b>Owner:</b> {{ ann.getOwner.getFullName }}<br />
                                    <b>Date:</b> {{ ann.creationEventDate|date:"Y-m-d H:i:s" }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% for ann in manager.boolean_annotations %}
                        <tr><th>Boolean:</th>
                            <td>
                                {{ ann.getValue }}
                                <span>{% if ann.ns %}<b>Namespace:</b> {{ ann.ns }}<br />{% endif %}
                                    {% if ann.description %}<b>Description:</b> {{ ann.description }}<br />{% endif %}
                                    <b>Owner:</b> {{ ann.getOwner.getFullName }}<br />
                                    <b>Date:</b> {{ ann.creationEventDate|date:"Y-m-d H:i:s" }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% for ann in manager.double_annotations %}
                        <tr><th>Double:</th>
                            <td>
                                {{ ann.getValue }}
                                <span>{% if ann.ns %}<b>Namespace:</b> {{ ann.ns }}<br />{% endif %}
                                    {% if ann.description %}<b>Description:</b> {{ ann.description }}<br />{% endif %}
                                    <b>Owner:</b> {{ ann.getOwner.getFullName }}<br />
                                    <b>Date:</b> {{ ann.creationEventDate|date:"Y-m-d H:i:s" }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% for ann in manager.term_annotations %}
                        <tr><th>Term:</th>
                            <td>
                                {{ ann.getValue }}
                                <span>{% if ann.ns %}<b>Namespace:</b> {{ ann.ns }}<br />{% endif %}
                                    {% if ann.description %}<b>Description:</b> {{ ann.description }}<br />{% endif %}
                                    <b>Owner:</b> {{ ann.getOwner.getFullName }}<br />
                                    <b>Date:</b> {{ ann.creationEventDate|date:"Y-m-d H:i:s" }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% for ann in manager.time_annotations %}
                        <tr><th>Time:</th>
                            <td>
                                {{ ann.getValue }}
                                <span>{% if ann.ns %}<b>Namespace:</b> {{ ann.ns }}<br />{% endif %}
                                    {% if ann.description %}<b>Description:</b> {{ ann.description }}<br />{% endif %}
                                    <b>Owner:</b> {{ ann.getOwner.getFullName }}<br />
                                    <b>Date:</b> {{ ann.creationEventDate|date:"Y-m-d H:i:s" }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                </td>
            </tr>
                      
            <!-- COMMENT -->
            <tr>
                <th colspan="3">                
                    {% trans "Comment:" %}
                    {% if manager.project.isEditable or manager.dataset.isEditable or manager.image.isEditable %}
                    <form action="{% if manager.project %}{% url manage_action_containers "addcomment" "project" manager.project.id %}{% else %}{% if manager.dataset %}{% url manage_action_containers "addcomment" "dataset" manager.dataset.id %}{% else %}{% if manager.image %}{% url manage_action_containers "addcomment" "image" manager.image.id %}{% else %}{% if manager.screen %}{% url manage_action_containers "addcomment" "screen" manager.screen.id %}{% else %}{% if manager.plate %}{% url manage_action_containers "addcomment" "plate" manager.plate.id %}{% else %}{% if manager.well %}{% url manage_action_containers "addcomment" "well" manager.well.id %}{% else %}{{ url }}{% endif %}{% endif %}{% endif %}{% endif %}{% endif %}{% endif %}?url={{url}}" method="post">
                    <table>
                        {% for field in form_comment %}
                            <tr>
                                <td colspan="2">{% if field.errors %}{{ field.errors }}{% endif %}</td>
                            </tr>
                            <tr>
                                <td>{{ field }}</td><td>{{ field.help_text|safe }}</td>
                            </tr>
                        {% endfor %}
                            <tr><td colspan="2"><input type="submit" value="{% trans 'Add Comment' %}" /></td></tr>
                    </table>
                    </form>
                    {% endif %}                        
                </th>
            </tr>
            <tr>
                <td colspan="3">
                    {% if manager.txannSize %}
                    <div class="lncomments">            
                        {% for tann in manager.text_annotations %}
                        <div class="ann_comment_wrapper">
                            <div class="avatar"><img src="{% url load_photo tann.details.owner.id.val %}" alt="{{ tann.getOwner.getFullName }}" title="{{ tann.getOwner.getFullName }}" width="20" height="20" /></div>
                            <div><span class="ann_comment_header">{{ tann.getOwner.getFullName }} {% trans "at" %} {{ tann.creationEventDate|date:"Y-m-d H:i:s" }}</span>{% if tann.canDelete %} <input class="button" type="image" src="{% url webstatic "images/cancel12.png" %}" alt="Delete" title="Delete" onclick="deleteItem('comment', '{{ tann.id }}');" />{% endif %}<br/>
                                {{ tann.textValue|safe|linebreaks }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                        {% trans "No comments." %}                        
                    {% endif %}
                </td>
            </tr>            
            </table>            
            <div class="clear"></div>          
        </div>
        {% endif %}
    </div>
    
</div>
{% endblock %}