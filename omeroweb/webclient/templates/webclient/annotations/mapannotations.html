
<!--
  Copyright (C) 2015 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->


<script>

    $(function(){

        // we are only ever editing a single cell at once:
        var $input,
            $lastRow = $("#keyValueTable tr:last").clone(),
            multiSelectKey = OME.multi_key() + "Key";

        // stop editing the current $input
        var saveEdit = function saveEdit() {

            if ($input) {
                var val = $input.val().trim();
                val = val.escapeHTML();
                $input.parent().html(val);

                // TODO: save row/table to server
            }
        };

        // start editing a td
        var startEdit = function startEdit($td) {

            var value = $td.text();
            $input = $("<input value='" + value + "' />");
            $td.empty().append($input);
            $input.focus();
            $input.get(0).select();
        }


        var addRow = function addRow() {

            var $tr = $lastRow
                    .clone()
                    .appendTo("#keyValueTable tbody"),
                $td = $tr.find("td:first");
            selectRows($tr);
            startEdit($td);
        }

        var deleteSelectedRows = function deleteSelectedRows() {

            $("#keyValueTable tbody tr.ui-selected").remove();

            // TODO: save to server
        }

        var selectRows = function selectRows($clickedRow, event) {

            var $rows = $("#keyValueTable tbody tr");

            // simplest case - no event OR key modifiers
            if (!event || (!event.shiftKey && !event[multiSelectKey])) {
                $rows.removeClass("ui-selected");
                $clickedRow.addClass("ui-selected");
                return;
            }

            // Use key modifiers to select range / toggle selection
            var clickedIndex = $rows.index($clickedRow),
                $selectedRow = $("#keyValueTable tbody tr.ui-selected:first"),
                selIndex = -1;
            if ($selectedRow.length > 0) {
                selIndex = $rows.index($selectedRow);
            }

            if (event.shiftKey) {
                // user tried to select a range, but we don't have a first selection yet...
                if ( selIndex == -1 ) {
                    $clickedRow.addClass("ui-selected");
                    return;
                }
                // select range
                var start = Math.min(clickedIndex,selIndex);
                var end = Math.max(clickedIndex,selIndex);
                $rows.slice(start, end+1).addClass("ui-selected");
            } else if (event[multiSelectKey]) {
                // user wants to add/remove a single image to selection
                $clickedRow.toggleClass("ui-selected");
            }
        }

        var copySelectedRows = function copySelectedRows() {

            var data = [];
            $("#keyValueTable tbody tr.ui-selected").each(function(){
                var key = $("td:first", this).text(),
                    val = $("td:last", this).text();
                data.push([key, val]);
            });
            window.mapAnnotationClipboard = data;
        };

        // If we have data to paste, insert below selected row, or at bottom
        var pasteSelectedRows = function copySelectedRows() {

            var data = window.mapAnnotationClipboard,
                row,
                html = "";

            for (var r=0; r<data.length; r++) {
                row = data[r];
                html += "<tr><td>" + row[0] + "</td><td>" + row[1] + "</td></tr>";
            }
            $(html).appendTo("#keyValueTable tbody");
        }

        // Toolbar buttons
        $( ".mapAnnToolbar" ).on( "click", "input", function(event) {
            var alt = $(event.target).prop('alt');
            switch (alt) {
                case "Delete rows":
                    deleteSelectedRows();
                    break;
                case "Copy rows":
                    copySelectedRows();
                    break;
                case "Paste rows":
                    pasteSelectedRows();
                    break;
            }
        });

        // Start editing when you click a td
        $( "#keyValueTable tbody" ).on( "click", "td", function(event) {
            var $td = $(event.target);
            // ignore clicks on other elements, e.g. <input>
            if ($td[0].tagName.toLowerCase() != "td") return;

            // Saving any other current editing is handled by 'blur' below.

            // Select rows, depending on shift/command keys
            selectRows($td.parent(), event);

            startEdit($td);
        });

        // Handle keys when editing
        // Start editing when you click a td
        $( "#keyValueTable tbody" ).on( "keydown", "input", function(event) {
            var $td = $(event.target).parent();

            switch (event.which) {
                case 13:
                    // Enter: save
                case 9:
                    // Tab: save
                    saveEdit();
                    // if we're on 'key', move to 'value'
                    if ($td.next().length > 0) {
                        startEdit($td.next());
                    // if we have another row, move to 'key'
                    } else if ($td.parent().next().length > 0) {
                        selectRows($td.parent().next());
                        startEdit($td.parent().next().find('td:first'));
                    } else {
                        addRow();
                    }
                    break;
            }

            // Ignore Tab
            if (event.which == 9) return false
        });

        $( "#keyValueTable tbody" ).on( "blur", "input", function(event) {
            saveEdit();
        });
    });

</script>

<style type="text/css">
    .mapAnnContainer {
        position: relative;
/*        top: -10px;*/
    }
    .keyValueTable {
        position: relative;
        top: 10px;
        margin-bottom: 10px;
    }
    .keyValueTable td {
        width: 50%;
        padding: 2px !important;
        height: 20px;
        vertical-align: middle;
    }
    .keyValueTable input {
        width: 96%;
    }
    .editableKeyValueTable tr:hover {
        background-color: #eee;
    }
    .editableKeyValueTable tr.ui-selected {
        background-color: #ddf;
    }
    .mapAnnToolbar {
        position: absolute;
        top: 0px;
        right: 5px;
        z-index: 100;
    }
</style>

{% for ma in manager.map_annotations %}
<div class="mapAnnContainer">

    <ul class="toolbar mapAnnToolbar">
        <li><input class="button" type="image" src="{% static "webclient/image/icon_basic_delete.png" %}"
            alt="Delete rows" title="Delete rows" /></li>        
        <li><input class="button" type="image" src="{% static "webclient/image/icon_toolbar_copy.png" %}"
            alt="Copy rows" title="Copy rows" /></li>
        <li><input class="button" type="image" src="{% static "webclient/image/icon_toolbar_paste.png" %}"
            alt="Paste rows" title="Paste rows" /></li>
    </ul>


    <table id="keyValueTable" class="keyValueTable editableKeyValueTable">
        <thead>
            <tr>
                <th>Key</th>
                <th>Value</th>
            </tr>
        </thead>

        <!-- Last row always has empty key & value fields -->
        {% for row in ma.getValue %}
        <tr>
            <td>{{ row.0 }}</td>
            <td>{{ row.1 }}</td>
        </tr>
        {% endfor %}
        <tr>
            <td>Add Key</td>
            <td>Add Value</td>
        </tr>
    </table>
</div>
{% endfor %}
