
{% comment %}
<!--
  Copyright (C) 2015 University of Dundee & Open Microscopy Environment.
  All rights reserved.

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
{% endcomment %}


<script>

    $(function(){

        // we are only ever editing a single cell at once:
        var $input,
            saveInProgress = false,
            saveTimeout,
            $lastRow = $(".editableKeyValueTable tr:last").clone(),
            multiSelectKey = OME.multi_key() + "Key";

        // stop editing the current $input
        var saveEdit = function saveEdit() {

            if ($input) {
                var val = $input.val().trim(),
                    $td = $input.parent(),
                    $table = $td.parent().parent().parent();
                $input = undefined;
                val = val.escapeHTML();
                $td.html(val);

                // save to server
                saveMapAnnotation($table);
            }
        };

        // Get the content of a $td (may contain <input>)
        var getCellText = function getCellText($td) {
            var $i = $td.children('input');
            if ($i.length > 0) {
                return $i.val().trim();
            }
            return $td.text().trim();
        }
        // Get the [key, value] data for a $tr
        var getRowData = function getRowText($tr) {
            var key = getCellText($tr.children('td:first')),
                val = getCellText($tr.children('td:last'));
            return [key, val]
        }

        // Save $table data to OMERO via $.post()
        var saveMapAnnotation = function saveMapAnnotation($table) {

            // Don't want asynchronous saving. Wait for save to complete
            if (saveInProgress) {
                // Try again in a second
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }
                saveTimeout = setTimeout(function() {
                    saveMapAnnotation($table);
                }, 1000);
                return;
            };

            var annId = $table.attr('data-annId'),
                url = "{% url 'annotate_map' %}",
                data = {"{{ manager.obj_type }}": {{ manager.obj_id }} },
                $mapAnnotationSpinner = $(".mapAnnotationSpinner", $table.parent()),
                tableData = [];

            $table.find('tbody tr').each(function() {
                var rowData = getRowData($(this)),
                    k = rowData[0],
                    v = rowData[1];
                // Don't add placeholder rows or empty rows
                if ((k == "Add Key" || k == "") && (v == "Add Value" || v =="")) return;
                tableData.push(rowData);
            });
            // If we are editing a saved map annotation...
            if (annId) {
                data.annId = annId;
            }

            data.mapAnnotation = JSON.stringify(tableData);

            saveInProgress = true;
            $mapAnnotationSpinner.show();
            $.post( url, data)
                .done(function( data ) {
                    saveInProgress = false;
                    $mapAnnotationSpinner.hide();
                    $table.attr('data-annId', data.annId);
                });
        };

        // start editing a td
        var startEdit = function startEdit($td) {

            var value = getCellText($td);
            // If we're editing a placeholder row, clear both fields
            $td.parent().removeClass("placeholder");
            if (value == "Add Key") {
                value = "";
                if (getCellText($td.next()) == "Add Value") {
                    $td.next().text("");
                }
            }
            if (value == "Add Value") {
                value = "";
                if (getCellText($td.prev()) == "Add Key") {
                    $td.prev().text("");
                }
            }
            $input = $("<input value='" + value + "' />");
            $td.empty().append($input);
            $input.focus();
            $input.get(0).select();
        }


        var startNewRow = function startRow($tr) {
            var $newRow = $lastRow.clone();
            $newRow.insertAfter($tr);

            selectRows($newRow);
            startEdit($newRow.find("td:first"));
        }


        // either use $tr OR event to determine where to add rows
        var addRow = function addRow(event) {

            var $newRow = $lastRow.clone();

            var $tbody = $(event.target)
                    .parent().parent().parent().find('.keyValueTable tbody');
            addToTable($tbody, $newRow);
        }

        var addToTable = function addToTable($tbody, $rows) {
            // Either paste after last selected row, or at bottom of table
            var $selRow = $tbody.find('tr.ui-selected:last')

            if ($selRow.length > 0) {
                $rows.insertAfter($selRow);
            } else {
                // If the last row is placeholder 'Add Key', 'Add Value', paste before
                var $lastRow = $('tr:last', $tbody),
                    rowData = getRowData($lastRow);
                if (rowData[0] == "Add Key" && rowData[1] == "Add Value") {
                    $rows.insertBefore($lastRow);
                } else {
                    $rows.appendTo($tbody);
                }
            }

            saveMapAnnotation($tbody.parent());
        }

        var deleteSelectedRows = function deleteSelectedRows(event) {

            var $table = $(event.target)
                    .parent().parent().parent()
                    .find('.keyValueTable'),
                $selRows = $table.find('tbody tr.ui-selected');
            $selRows.remove();
            if ($table.find('tbody tr').length == 0) {
                $lastRow.clone().appendTo($table);
            }

            saveMapAnnotation($table);
        }

        var selectRows = function selectRows($clickedRow, event) {

            var $rows = $clickedRow.parent().children('tr');

            // Use key modifiers to select range / toggle selection

            // simplest case - no event OR key modifiers
            if (!event || (!event.shiftKey && !event[multiSelectKey])) {
                $('.keyValueTable tr').removeClass("ui-selected");
                $clickedRow.addClass("ui-selected");
            } else if (event.shiftKey) {

                var clickedIndex = $rows.index($clickedRow),
                    $selectedRow = $rows.filter(".ui-selected:first"),
                    selIndex = -1;
                if ($selectedRow.length > 0) {
                    selIndex = $rows.index($selectedRow);
                }
                $('.keyValueTable tr').removeClass("ui-selected");
                // user tried to select a range, but we don't have a first selection yet...
                if ( selIndex == -1 ) {
                    $clickedRow.addClass("ui-selected");
                } else {
                    // select range
                    var start = Math.min(clickedIndex,selIndex);
                    var end = Math.max(clickedIndex,selIndex);
                    $rows.slice(start, end+1).addClass("ui-selected");
                }
            } else if (event[multiSelectKey]) {
                // user wants to add/remove a single image to selection
                var $selectedRows = $rows.filter(".ui-selected");
                $('.keyValueTable tr').removeClass("ui-selected");
                $selectedRows.addClass("ui-selected");
                $clickedRow.toggleClass("ui-selected");
            }

            enableToolbarButtons();
        }

        var enableToolbarButtons = function enableToolbarButtons() {

            var $selRows = $('.keyValueTable tr.ui-selected'),
                enabled = {"Insert rows": false,
                            "Copy rows": false,
                            "Paste rows": false,
                            "Delete rows": false},
                data = window.mapAnnotationClipboard,
                canPaste = (data && data.length > 0);

            // Nothing selected - actions will apply to user's own table
            if ($selRows.length == 0) {
                enabled["Insert rows"] = true;
                enabled["Copy rows"] = false;
                enabled["Paste rows"] = canPaste;
                enabled["Delete rows"] = false;
            } else {
                var $table = $selRows.parent().parent(),
                    canEdit = $table.hasClass('editableKeyValueTable');
                enabled["Insert rows"] = canEdit;
                enabled["Copy rows"] = true;
                enabled["Paste rows"] = (canPaste && canEdit);
                enabled["Delete rows"] = canEdit;
            }
            $(".mapAnnToolbar input").each(function(){
                var $input = $(this),
                    title = $input.attr("title");
                if (enabled.hasOwnProperty(title)) {
                    if (enabled[title]) $input.removeClass('button-disabled');
                    else $input.addClass('button-disabled');
                }
            })
        };

        var copySelectedRows = function copySelectedRows(event) {

            var $tbody = $(event.target)
                    .parent().parent().parent().find('.keyValueTable tbody'),
                data = [];
            $tbody.find("tr.ui-selected").each(function(){
                var rowData = getRowData($(this));
                data.push(rowData);
            });
            window.mapAnnotationClipboard = data;
        };

        // If we have data to paste, insert below selected row, or at bottom
        var pasteSelectedRows = function pasteSelectedRows(event) {

            var $tbody = $(event.target)
                    .parent().parent().parent().find('.keyValueTable tbody'),
                data = window.mapAnnotationClipboard,
                row,
                html = "";

            if (!data || data.length == 0) return;

            for (var r=0; r<data.length; r++) {
                row = data[r];
                html += "<tr><td>" + row[0] + "</td><td>" + row[1] + "</td></tr>";
            }
            // Either paste after last selected row, or at bottom of table
            addToTable($tbody, $(html));

            saveMapAnnotation($tbody.parent());
        }

        // Toolbar buttons
        $( ".mapAnnToolbar" ).on( "click", "input", function(event) {
            var alt = $(event.target).prop('alt');
            switch (alt) {
                case "Delete rows":
                    deleteSelectedRows(event);
                    break;
                case "Copy rows":
                    copySelectedRows(event);
                    break;
                case "Paste rows":
                    pasteSelectedRows(event);
                    break;
                case "Insert rows":
                    addRow(event);
            }
        });

        // Select (and Start editing?) when you click a td
        $( ".keyValueTable tbody" ).on( "click", "td", function(event) {
            var $td = $(event.target);
            // ignore clicks on other elements, e.g. <input>
            if ($td[0].tagName.toLowerCase() != "td") return;

            // Saving any other current editing is handled by 'blur' below.

            // Select rows, depending on shift/command keys
            selectRows($td.parent(), event);

            if ($td.parent().parent().parent().hasClass('editableKeyValueTable')) {
                startEdit($td);
            }
        });

        // Handle keys when editing
        // Start editing when you click a td
        $( ".editableKeyValueTable tbody" ).on( "keydown", "input", function(event) {
            var $td = $(event.target).parent();

            switch (event.which) {
                case 13:
                    // Enter: save
                case 9:
                    // Tab: save
                    saveEdit();
                    // if we're on 'key', move to 'value'
                    if ($td.next().length > 0) {
                        startEdit($td.next());
                    // if we have another row, move to 'key'
                    } else if ($td.parent().next().length > 0) {
                        selectRows($td.parent().next());
                        startEdit($td.parent().next().find('td:first'));
                    } else {
                        startNewRow($td.parent());
                    }
                    break;
            }

            // Ignore Tab
            if (event.which == 9) return false
        });

        $( ".keyValueTable tbody" ).on( "blur", "input", function(event) {
            saveEdit();
        });
    });

</script>

<style type="text/css">
    .mapAnnContainer {
        position: relative;
/*        top: -10px;*/
    }
    .keyValueTable {
        position: relative;
        top: 10px;
        margin-bottom: 20px;
        width: 98% !important;
    }
    .keyValueTable td, .keyValueTable th {
        width: 50%;
        padding: 2px 5px !important;
        color: hsl(210,10%,30%) !important;
        height: 20px;
        vertical-align: middle;
    }
    .keyValueTable input {
        width: 96%;
    }
    .keyValueTable tr:hover {
        background-color: #eee;
    }
    .keyValueTable tr.ui-selected {
        background-color: #cddcfc;
    }
    .editableKeyValueTable tr {
        background-color: #fff;
        border: solid #ddd 1px;
    }
    .editableKeyValueTable thead tr {
        background-color: transparent;
        border: solid transparent 1px;
    }
    .mapAnnToolbar {
        position: absolute;
        top: 0px;
        right: 5px;
        z-index: 100;
    }
    .editableKeyValueTable tr.placeholder td {
        font-style: italic;
        color: #999 !important;
    }
</style>

<div class="mapAnnContainer">
    <ul class="toolbar mapAnnToolbar">
        <!-- not really a button - just a handy place to put a spinner -->
        <li class="mapAnnotationSpinner" style="display:none">
            <input class="button" type="image"
              src="{% static "webgateway/img/spinner.gif" %}" title="Saving to server..." /></li>
        <li><input class="button button-disabled" type="image"
            src="{% static "webclient/image/icon_toolbar_add.png" %}"
            alt="Insert rows" title="Insert rows" /></li>
        <li><input class="button button-disabled" type="image" src="{% static "webclient/image/icon_toolbar_copy.png" %}"
            alt="Copy rows" title="Copy rows" /></li>
        <li><input class="button button-disabled" type="image"
            src="{% static "webclient/image/icon_toolbar_paste.png" %}"
            alt="Paste rows" title="Paste rows" /></li>
        <li><input class="button button-disabled" type="image"
            src="{% static "webclient/image/icon_basic_delete.png" %}"
            alt="Delete rows" title="Delete rows" /></li>
    </ul>

{% if manager.my_client_map_annotations %}
    {% for ma in manager.my_client_map_annotations %}
        {% with canEdit=ma.canEdit showTableHead=True %}
            {% include "webclient/annotations/mapannotation.html" %}
        {% endwith %}
    {% endfor %}
{% else %}
    <!-- Add an empty placeholder -->
    {% with canEdit=True %}
        {% include "webclient/annotations/mapannotation.html" %}
    {% endwith %}
{% endif %}

{% if manager.client_map_annotations %}
<hr>
{% for ma in manager.client_map_annotations %}
    {% with canEdit=ma.canEdit %}
        {% include "webclient/annotations/mapannotation.html" %}
    {% endwith %}
{% endfor %}
{% endif %}

{% if manager.map_annotations %}
<hr>
{% for ma in manager.map_annotations %}
    {% with canEdit=False %}
        {% include "webclient/annotations/mapannotation.html" %}
    {% endwith %}    
{% endfor %}
{% endif %}

</div>
